# 项目架构演进记录

本文档记录项目架构的重要演进和决策。

## 2024-12-20 - 契约层重构与系统统一

### 1. 契约层重构
**背景**：旧的 `.t.model.ts` 格式不够灵活，难以扩展业务逻辑

**改进**：
- 完全迁移到新的 `.contract.ts` 格式
- 目录结构从多级目录（auth/、company/、content/等）简化为扁平的 `_custom/` 目录
- 清理了所有旧的类型定义文件

**新格式优势**：
- 继承自动生成的基础契约，避免重复定义
- 支持业务逻辑扩展（批量操作、统计、导入导出等）
- 统一的 DTO 类型导出
- 更好的类型安全保障

### 2. 错误处理系统统一
**背景**：Web 项目缺少完善的错误处理和日志系统

**改进**：
- 从 B2B Admin 项目完整复制错误处理和日志系统到 Web 项目
- 实现统一的错误处理流程
- 数据库错误到 HTTP 状态码的智能映射

**技术实现**：
- `errorPlugin` - 全局错误处理插件
- `database-error-mapper.ts` - 数据库错误映射
- `logixlysia` - 日志系统

### 3. 环境变量配置完善
**背景**：缺少清晰的环境变量配置，开发和生产环境混用

**改进**：
- 创建独立的开发和生产环境配置文件
- 明确本地数据库和服务器数据库的使用场景
- 添加缺失的环境变量 `BETTER_AUTH_BASE_URL`

**配置文件**：
- `.env.development` - 开发环境（本地数据库）
- `.env.production` - 生产环境（服务器数据库）

### 4. 项目目录结构优化
**之前**：
```
modules/
├── auth/auth.t.model.ts
├── auth/permission.t.model.ts
├── company/exporter.t.model.ts
├── content/ads.t.model.ts
└── ...（多级目录，混乱）
```

**现在**：
```
modules/
├── _custom/              # 自定义扩展（手动维护）
│   ├── ads.contract.ts
│   ├── auth.contract.ts
│   └── ...
├── _generated/           # 自动生成（脚本维护）
│   ├── account.contract.ts
│   ├── ads.contract.ts
│   └── ...
└── index.ts              # 统一导出（脚本更新）
```

### 5. 技术债务清理
- 删除了所有旧的 `.t.model.ts` 文件
- 移除了临时的文档文件
- 统一使用 `*Contract` 类型，废弃 `*TModel` 类型
- 清理了过时的目录结构

## 下一步计划

### 1. 自动化脚本增强
- 改进 `gen-all-final.ts` 脚本，自动更新 `index.ts`
- 添加契约验证，确保类型一致性
- 支持自定义契约的自动发现

### 2. 类型系统优化
- 探索使用 TypeScript 5.0 的新特性
- 优化类型推导性能
- 增强类型错误提示

### 3. 开发工具完善
- 创建契约生成 CLI 工具
- 添加类型检查钩子
- 完善开发文档

## 架构原则

1. **Schema 驱动**：所有业务改动从 `table.schema.ts` 开始
2. **类型安全**：前后端共享类型定义，避免类型不一致
3. **自动化优先**：减少手写代码，通过脚本自动生成
4. **清晰分离**：自动生成和手动扩展明确分离
5. **统一标准**：所有模块遵循相同的架构模式

## 总结

通过这次重构，项目获得了：
- 更清晰的架构层次
- 更好的类型安全保障
- 更强的可扩展性
- 更统一的开发体验

这些改进为项目的长期维护和发展奠定了坚实的基础。