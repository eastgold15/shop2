# 多站点电商平台架构文档

## 概述

本文档描述了如何在现有的电商平台基础上，实现"一个后台管理系统支持多个前端网站"的架构。该方案通过站点隔离机制，让每个网站可以独立运营，同时共享同一套后端系统。

## 核心设计原则

1. **商品只属于工厂**：工厂是商品的唯一所有者
2. **出口商是聚合者**：不直接拥有商品，而是管理下属工厂
3. **独立建站能力**：每个实体（工厂/出口商）都能独立建立自己的网站
4. **展示逻辑隔离**：分类、主题、配置等按站点完全隔离

## 架构图

```
┌─────────────────────────────────────────────────────┐
│                   统一后端 API                        │
│                  (b2badmin)                         │
├─────────────────────────────────────────────────────┤
│          Site Context (站点上下文层)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │
│  │   Factory    │  │  Exporter    │  │   Admin     │ │
│  │   Site       │  │   Site       │  │   System    │ │
│  └──────────────┘  └──────────────┘  └─────────────┘ │
├─────────────────────────────────────────────────────┤
│                Business Logic                       │
│              (业务逻辑层，隔离数据)                    │
└─────────────────────────────────────────────────────┘
         ↓ API with Site Context ↓
┌─────────────────────────────────────────────────────┐
│  Site A (Factory Site)  │  Site B (Exporter Site)  │
└─────────────────────────────────────────────────────┘
```

你的权限系统只需要这唯一的一条链路： User -> Site (Context) -> Role -> Permissions

## 数据库设计
统一后台管理系统实现计划

 项目概述

 实现一个统一的Elysia后台管理系统，支持超级admin、出口商admin、工厂管理员、业务员四种角色，通过站点切换器实现不同身份的
 管理功能。

 核心需求

 1. 超级管理员：可通过站点切换器访问所有站点，拥有全局管理权限
 2. 多角色支持：用户在不同站点可拥有不同角色身份
 3. 动态界面：基于当前站点和角色权限动态显示/隐藏界面组件
 4. 统一工作台：一个系统支持多种角色，无需重复开发

 技术架构分析

 现有基础设施

 - 数据库：PostgreSQL + Drizzle ORM，已支持用户-站点-角色关联
 - 认证系统：Better Auth + 自定义认证插件
 - 权限系统：基于RBAC的权限控制
 - 前端架构：Next.js + Elysia，类型安全的API调用

 关键数据表

 - usersTable - 用户基础信息，包含isSuperAdmin标识
 - sitesTable - 站点信息，支持factory和exporter两种类型
 - userSiteRolesTable - 用户-站点-角色关联表
 - roleTable - 角色定义，包含优先级和权限

 实施计划

 第一阶段：后端核心功能（优先级：高）

 1.1 站点切换API

 文件：apps/b2badmin/src/server/modules/site/site.ts
 - 新增 POST /site/switch 接口，实现站点切换逻辑
 - 新增 GET /site/accessible 接口，获取用户可访问站点列表
 - 验证用户在目标站点的访问权限
 - 更新session中的当前站点信息

 1.2 增强用户信息接口

 文件：apps/b2badmin/src/server/modules/user/user.ts
 - 修改 /user/me 接口，支持siteId参数
 - 根据当前站点返回对应的角色和权限信息
 - 返回完整的组织架构和团队信息
 - 添加站点相关的统计数据

 1.3 认证中间件升级

 文件：apps/b2badmin/src/server/plugins/admin-auth.plugin.ts
 - 支持从请求头或session获取当前站点ID
 - 动态加载用户在当前站点的角色权限
 - 为API路由添加站点权限验证
 - 优化超级管理员的站点访问逻辑

 第二阶段：前端状态管理（优先级：高）

 2.1 站点状态管理

 文件：apps/b2badmin/src/stores/site-store.ts（新建）
 - 使用Zustand创建站点状态管理
 - 管理当前站点ID和可访问站点列表
 - 提供站点切换功能
 - 处理切换后的数据刷新

 2.2 用户权限Hooks增强

 文件：apps/b2badmin/src/hooks/api/user.ts
 - 更新所有hooks支持站点上下文
 - 添加 useCurrentSite hook获取当前站点信息
 - 添加 useSitePermissions hook获取站点特定权限
 - 实现权限检查的便捷方法

 2.3 站点切换器改造

 文件：apps/b2badmin/src/components/team-switcher.tsx
 - 添加站点切换交互功能
 - 显示当前站点和可切换站点列表
 - 支持站点类型标识（工厂/出口商）
 - 添加切换确认对话框

 第三阶段：界面适配（优先级：中）

 3.1 工作台动态化

 文件：apps/b2badmin/src/components/dashboard/UserDashboard.tsx
 - 根据当前角色动态显示统计数据
 - 根据站点类型调整快速操作入口
 - 添加站点切换提示
 - 优化超级管理员的数据聚合显示

 3.2 导航菜单权限控制

 文件：apps/b2badmin/src/components/app-sidebar.tsx
 - 菜单项根据当前站点和角色动态显示
 - 超级管理员可看到所有功能模块
 - 添加站点特定的菜单项
 - 实现菜单项的权限细粒度控制

 3.3 权限守卫组件

 文件：apps/b2badmin/src/components/guards/PermissionGuard.tsx（新建）
 - 创建通用权限守卫组件
 - 支持角色、权限、站点多维度控制
 - 提供便捷的权限检查hooks
 - 实现权限不足时的友好提示

 第四阶段：优化与完善（优先级：中）

 4.1 API客户端优化

 文件：apps/b2badmin/src/lib/api.ts
 - 自动添加当前站点ID到请求头
 - 处理站点切换时的API缓存失效
 - 优化错误处理和重试机制
 - 添加请求级loading状态

 4.2 数据缓存策略

 - 使用React Query管理站点相关数据
 - 实现跨站点的数据隔离
 - 优化站点切换时的数据预加载
 - 处理缓存失效和更新策略

 4.3 用户体验优化

 - 添加站点切换加载动画
 - 实现站点切换的历史记录
 - 优化移动端站点选择器
 - 添加键盘快捷键支持

 第五阶段：测试与安全（优先级：高）

 5.1 安全加固

 - 验证所有API的站点权限检查
 - 防止越权访问其他站点数据
 - 记录站点切换审计日志
 - 实现会话超时自动跳转

 5.2 全面测试

 - 编写单元测试覆盖核心逻辑
 - 进行集成测试验证权限隔离
 - 性能测试确保切换流畅
 - 用户验收测试

 关键技术点

 站点切换流程

 sequenceDiagram
     participant U as User
     participant F as Frontend
     participant A as API
     participant D as Database

     U->>F: 选择站点
     F->>A: POST /site/switch
     A->>D: 验证用户权限
     A->>D: 更新session
     A->>F: 返回成功
     F->>F: 更新本地状态
     F->>F: 刷新页面数据

 权限检查机制

 1. 前端控制：基于当前角色动态显示/隐藏UI组件
 2. API验证：每个请求验证用户在当前站点的权限
 3. 数据过滤：查询时自动过滤用户可见数据范围
 4. 操作限制：关键操作二次验证权限

 数据安全措施

 - 不在本地存储敏感权限信息
 - 使用HTTPS传输所有数据
 - 实现CSRF防护
 - 定期更新用户权限缓存

 预期成果

 完成后，系统将实现：
 1. 超级管理员可以一键切换管理任意站点
 2. 普通用户在不同站点拥有独立角色和数据访问权限
 3. 统一界面根据当前上下文自动调整，无需重复开发
 4. 安全隔离严格的数据权限控制和访问验证
 5. 良好体验流畅的站点切换和权限过渡



  权限结构总结：

  1. 超级管理员 (super_admin)

  - ✅ 可以创建任何类型的站点（工厂站点、出口商站点）
  - ✅ 可以管理所有站点
  - ✅ 可以访问所有站点的数据

  2. 出口商管理员 (exporter_admin)

  - ✅ 可以创建自己旗下工厂的站点
  - ✅ 可以管理自己的出口商站点
  - ✅ 可以管理旗下工厂的所有站点
  - ❌ 不能创建出口商站点（只有超级管理员可以）

  3. 工厂管理员 (factory_admin)

  - ✅ 可以管理自己的工厂站点
  - ❌ 不能创建站点
  - ❌ 不能管理其他工厂的站点

  4. 业务员 (salesperson)

  - ❌ 不能管理站点配置
  - ✅ 只能操作被分配站点的业务数据

  这样的权限结构确保了：
  - 数据的安全性和隔离性
  - 每个角色只能在其权限范围内操作
  - 出口商可以统一管理其旗下所有工厂的站点
  - 工厂有自主管理自己站点的权限


  工厂级管理 (由工厂业务员主导)
谁在操作： 工厂业务员 (salespersonsTable 关联到 usersTable)。

操作流程：

业务员登录系统。

他们被授权管理特定工厂 (salespersonAffiliationsTable 记录了他们与哪个 Factory/Exporter 关联)。

他们直接在 productsTable 中创建/编辑商品，确保 factoryId 正确指向他们的工厂。

他们维护商品细节 (SKU、图片、属性等)。

您的参与： 无需参与，除非您需要审核数据。

2. 出口商级管理/站点聚合 (由您或您的管理员主导)
谁在操作： 您或您的超级管理员 (isSuperAdmin: true 或有相应角色的用户)。

操作流程：

您登录系统，切换到您的出口站点 (sitesTable 中 siteType 为 'exporter' 的记录)。

进入“产品管理”或“站点商品聚合”界面。

通过 siteProductsTable 关联工厂商品：您选择一个已存在的商品 (productId)，将其链接到您的站点 (siteId)。

在 siteProductsTable 中，您可以设置此商品在您站点上的独立价格 (sitePrice)、名称 (siteName) 和分类 (siteCategoryId)。

目的： 您不修改工厂的原始数据，您只是引用并定制它在您的出口站点上的表现。

结论：

您作为出口商，主要关注宏观的聚合和站点的定制化配置（sitesTable, siteProductsTable, siteConfigTable）。具体的商品细节维护（如 SKU 价格、库存、产品描述）应由工厂业务员完成，实现了职责分离和数据源的单一性。

---

## 商品管理完整流程

### 工厂级商品管理（商品源头）

**执行者**：工厂业务员

**流程**：

1. **创建商品**：在 `productsTable` 中创建商品
   - 设置 `factoryId` 为所属工厂 ID
   - 设置 `tenantId` 为出口商 ID
   - 添加 SKU、媒体、规格等信息

2. **维护商品信息**：直接操作商品数据
   - 更新价格、库存、描述
   - 上传产品图片和视频
   - 管理规格和模板

3. **商品归工厂所有**：商品的 `factoryId` 决定了归属
   - 商品属于工厂的资产
   - 出口商不直接拥有商品

### 站点级商品聚合（展示层）

**执行者**：出口商管理员

**流程**：

1. **选择站点**：在站点切换器中选择要操作的站点
2. **浏览工厂商品**：查看所有工厂创建的商品
3. **关联到站点**：通过 `siteProductsTable` 将商品关联到站点
4. **站点定制**：设置站点特定的价格、名称、分类

**关键表**：
- `siteProductsTable` - 站点商品映射表
  - `siteId` - 所属站点
  - `productId` - 原始商品 ID
  - `sitePrice` - 站点特定价格
  - `siteName` - 站点特定名称
  - `siteCategoryId` - 站点特定分类

### 数据流向图

```
┌─────────────┐
│ 工厂业务员    │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────┐
│    productsTable            │
│  (商品源头，属于工厂)          │
│  - factoryId: 工厂ID          │
│  - tenantId: 出口商ID         │
└──────┬──────────────────────┘
       │
       │ 引用
       ▼
┌─────────────────────────────┐
│   siteProductsTable         │
│  (站点商品映射，多对多)         │
│  - siteId: 站点ID             │
│  - productId: 商品ID          │
│  - sitePrice: 站点价格         │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│     sitesTable              │
│  (站点配置)                   │
│  - siteType: group/factory   │
│  - boundDeptId: 绑定部门      │
└─────────────────────────────┘
```

---

## 询盘分发流程

### 询盘来源

1. **站点询盘**：客户从不同站点（集团站或工厂站）提交询盘
2. **携带信息**：询盘自动包含 `siteId`，标识来源站点

### 分发策略

#### 集团站点询盘

```
客户询盘 (集团站)
       │
       ▼
┌──────────────────┐
│ inquiryTable     │
│ - siteId: 集团站ID │
│ - status: pending │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 出口商管理员      │
│ 手动分发逻辑：     │
│ 1. 查看询盘详情    │
│ 2. 选择处理工厂    │
│ 3. 分配给工厂业务员 │
└──────────────────┘
```

#### 工厂站点询盘

```
客户询盘 (工厂站)
       │
       ▼
┌──────────────────┐
│ inquiryTable     │
│ - siteId: 工厂站ID │
│ - factoryId: 工厂ID│
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 自动分配          │
│ 分配给该工厂的    │
│ 默认业务员        │
└──────────────────┘
```

### 分发规则

1. **自动分配**：工厂站点的询盘自动分配给该工厂的默认业务员
2. **手动分配**：集团站点的询盘由出口商管理员手动分配
3. **公海池**：未分配的询盘进入公海，业务员可以认领

### 询盘状态流转

```
pending (待处理)
    │
    ├─→ assigned (已分配)
    │       │
    │       ├─→ processing (处理中)
    │       │       │
    │       │       ├─→ quoted (已报价)
    │       │       │       │
    │       │       │       └─→ won (成交)
    │       │       │       │
    │       │       │       └─→ lost (流失)
    │       │       │
    │       │       └─→ closed (关闭)
    │       │
    │       └─→ rejected (已拒绝)
    │
    └─→ cancelled (已取消)
```

---

## 站点切换流程

### 前端切换器交互

```
用户点击站点切换器
       │
       ▼
┌─────────────────────┐
│ 显示可访问站点列表    │
│ - 集团站点            │
│ - 工厂A站点           │
│ - 工厂B站点           │
└──────────┬──────────┘
           │
           ▼
     用户选择目标站点
           │
           ▼
┌─────────────────────┐
│ 前端发起切换请求      │
│ POST /site/switch   │
│ { siteId: "xxx" }   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 后端验证权限         │
│ 1. 检查用户是否有权限│
│ 2. 获取站点角色      │
│ 3. 更新session      │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 返回切换结果         │
│ {                   │
│   success: true,    │
│   site: {...},      │
│   role: {...}       │
│ }                   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 前端更新状态         │
│ 1. 更新全局状态      │
│ 2. 刷新权限缓存      │
│ 3. 重新加载数据      │
│ 4. 更新界面显示      │
└─────────────────────┘
```

### 权限动态加载

切换站点后，系统会：

1. **清除旧权限**：移除上一个站点的权限缓存
2. **加载新权限**：获取用户在新站点的角色和权限
3. **界面适配**：根据新权限显示/隐藏功能模块
4. **数据过滤**：所有 API 请求自动带上新的 `siteId`

### API 请求头处理

```typescript
// 所有 API 请求自动添加站点上下文
{
  'Authorization': `Bearer ${token}`,
  'X-Site-Id': currentSiteId,  // 当前站点 ID
  'X-Role-Id': currentRoleId   // 当前角色 ID
}
```

### 数据隔离保证

切换站点后，前端和后端都会进行数据隔离：

**前端隔离**：
- React Query 缓存失效
- 重新查询数据
- 根据权限过滤显示

**后端隔离**：
- 从请求头读取 `siteId`
- 验证用户在该站点的权限
- 查询时自动添加 `siteId` 过滤条件

---

## 总结

本架构通过以下设计实现了多站点电商平台的核心需求：

1. **资产与展示分离**：商品属于工厂，站点通过映射表引用
2. **权限精细控制**：基于站点的用户角色分配
3. **数据严格隔离**：租户、部门、站点三层隔离机制
4. **灵活的业务流程**：支持不同的商品管理和询盘分发策略
5. **无缝站点切换**：动态权限加载和数据过滤