# é¡¹ç›®å‘½åè§„èŒƒæ–‡æ¡£ (æ¶æ„å¸ˆä¿®è®¢ç‰ˆ)

> **ç›®æ ‡**: å»ºç«‹"å†…å¤–æœ‰åˆ«"çš„æè‡´è°ƒç†ä½“ç³»ï¼Œå®ç°ä»è¿å­—ç¬¦æ–‡ä»¶ååˆ°å…¨æ ˆä»£ç çš„è‡ªåŠ¨åŒ–æ˜ å°„ï¼Œè¾¾æˆæœ€å°è®°å¿†è´Ÿæ‹…ã€‚

> **æ ¸å¿ƒç†å¿µ**: æ ¹æ®ç‰©ç†è¾¹ç•Œåˆ‡æ¢å‘½åè§„èŒƒ - æ–‡ä»¶/URLç”¨è¿å­—ç¬¦ï¼Œä»£ç å˜é‡ç”¨é©¼å³°ï¼Œæ•°æ®åº“ç”¨ä¸‹åˆ’çº¿

## ğŸ“‹ ç›®å½•

1. [å››ç»´ç©ºé—´å‘½åä½“ç³»](#1-å››ç»´ç©ºé—´å‘½åä½“ç³»)
2. [æ•°æ®åº“å±‚](#2-æ•°æ®åº“å±‚)
3. [å¥‘çº¦å±‚ (Contract)](#3-å¥‘çº¦å±‚-contract)
4. [æœåŠ¡å±‚ (Service)](#4-æœåŠ¡å±‚-service)
5. [æ§åˆ¶å™¨å±‚ (Controller)](#5-æ§åˆ¶å™¨å±‚-controller)
6. [å‰ç«¯ API Hooks](#6-å‰ç«¯-api-hooks)
7. [æƒé™å‘½å](#7-æƒé™å‘½å)
8. [å®Œæ•´ç¤ºä¾‹](#8-å®Œæ•´ç¤ºä¾‹)
9. [è‡ªåŠ¨åŒ–è½¬æ¢è§„åˆ™](#9-è‡ªåŠ¨åŒ–è½¬æ¢è§„åˆ™)
10. [æ€»ç»“](#10-æ€»ç»“)

---

## 1. å››ç»´ç©ºé—´å‘½åä½“ç³»

### 1.1 æ ¸å¿ƒåŸåˆ™

æˆ‘ä»¬å°†ç³»ç»Ÿåˆ†ä¸º**äº”ä¸ªç‰©ç†è¾¹ç•Œ**ï¼Œæ¯ä¸ªè¾¹ç•Œæ‰§è¡Œå”¯ä¸€çš„å‘½åæ ‡å‡†ï¼š

| è¾¹ç•Œ       | å‘½åè§„èŒƒ         | ç¤ºä¾‹                         | åº”ç”¨åœºæ™¯                 |
| -------- | ------------ | -------------------------- | -------------------- |
| **ç£ç›˜è¾¹ç•Œ** | `kebab-case` | `site-category.service.ts` | æ–‡ä»¶ã€ç›®å½•å               |
| **ç½‘ç»œè¾¹ç•Œ** | `kebab-case` | `/api/v1/site-category`    | URL è·¯å¾„ã€API è·¯ç”±        |
| **å†…å­˜è¾¹ç•Œ** | `camelCase`  | `siteCategoryService`      | å˜é‡ã€å‡½æ•°ã€å®ä¾‹ã€Schema      |
| **ç±»å‹è¾¹ç•Œ** | `PascalCase` | `SiteCategoryContract`     | ç±»åã€æ¥å£ã€ç±»å‹ã€Contract å¯¼å‡º |
| **å­˜å‚¨è¾¹ç•Œ** | `snake_case` | `site_category`            | æ•°æ®åº“è¡¨åã€å­—æ®µå            |

### 1.2 ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

#### ç£ç›˜/ç½‘ç»œè¾¹ç•Œä½¿ç”¨ `kebab-case` (è¿å­—ç¬¦)
- âœ… **è§†è§‰æ¸…æ™°**: `daily-inquiry-counter` æ¯” `dailyinquirycounter` æ›´æ˜“è¯»
- âœ… **SEO å‹å¥½**: æœç´¢å¼•æ“å°†è¿å­—ç¬¦è§†ä¸ºå•è¯åˆ†éš”ç¬¦
- âœ… **æ¶ˆé™¤æ­§ä¹‰**: å¼ºåˆ¶å…¨å°å†™ï¼Œé¿å…å¤§å°å†™ä¸æ•æ„ŸæœåŠ¡å™¨çš„é—®é¢˜
- âœ… **å·¥ä¸šæ ‡å‡†**: ç¬¦åˆ RFC 3986 URI è§„èŒƒ

#### å†…å­˜è¾¹ç•Œä½¿ç”¨ `camelCase` (é©¼å³°)
- âœ… **åŸç”Ÿå®¡ç¾**: ç¬¦åˆ JavaScript/TypeScript è¯­è¨€ä¹ æƒ¯
- âœ… **IDE å‹å¥½**: è‡ªåŠ¨è¡¥å…¨å’Œé‡æ„å·¥å…·æ”¯æŒæœ€ä½³
- âœ… **å¼€å‘ä½“éªŒ**: è¾“å…¥æµç•…ï¼Œæ— éœ€åˆ‡æ¢å¤§å°å†™

#### å­˜å‚¨è¾¹ç•Œä½¿ç”¨ `snake_case` (ä¸‹åˆ’çº¿)
- âœ… **æ•°æ®åº“ä¼ ç»Ÿ**: PostgreSQLã€MySQL ç­‰ä¸»æµæ•°æ®åº“çš„æƒ¯ä¾‹
- âœ… **ORM é»˜è®¤**: Drizzleã€Prisma ç­‰ ORM çš„é»˜è®¤æ˜ å°„è§„åˆ™
- âœ… **å­—æ®µåŒºåˆ†**: ä¸ç³»ç»Ÿå…³é”®å­—è‡ªç„¶åˆ†ç¦»

### 1.3 å››ç»´ç©ºé—´å¯¹ç…§è¡¨

| ç»´åº¦       | è§„èŒƒæ ‡å‡†         | ç¤ºä¾‹                         | åœºæ™¯           |
| -------- | ------------ | -------------------------- | ------------ |
| **ç‰©ç†ç©ºé—´** | `kebab-case` | `site-category.service.ts` | ç£ç›˜æ–‡ä»¶ã€ç›®å½•      |
| **ç½‘ç»œç©ºé—´** | `kebab-case` | `/api/v1/site-category`    | æµè§ˆå™¨ URLã€è·¯ç”±å‰ç¼€ |
| **é€»è¾‘ç©ºé—´** | `camelCase`  | `siteCategoryService`      | å†…å­˜å˜é‡ã€å‡½æ•°ã€å®ä¾‹   |
| **å®šä¹‰ç©ºé—´** | `PascalCase` | `SiteCategoryContract`     | ç±»å‹ã€ç±»ã€å¥‘çº¦å¯¼å‡º    |
| **æŒä¹…ç©ºé—´** | `snake_case` | `site_category`            | æ•°æ®åº“è¡¨ã€å­—æ®µ      |

---

## 2. æ•°æ®åº“å±‚

### 2.1 è¡¨åè§„èŒƒ

**è§„åˆ™**: `æ¨¡å—_å®ä½“å` (å…¨å°å†™ + ä¸‹åˆ’çº¿ + **å•æ•°**)

| ä¸šåŠ¡æ¨¡å— | è¡¨åç¤ºä¾‹             | å˜é‡å‘½å (`camelCase` + Table) |
| ---- | ---------------- | -------------------------- |
| ç³»ç»Ÿæ¨¡å— | `sys_tenant`     | `tenantTable`              |
| ç³»ç»Ÿæ¨¡å— | `sys_dept`       | `deptTable`                |
| ç«™ç‚¹æ¨¡å— | `site`           | `siteTable`                |
| ç«™ç‚¹æ¨¡å— | `site_category`  | `siteCategoryTable`        |
| äº§å“æ¨¡å— | `product`        | `productTable`             |
| äº§å“æ¨¡å— | `product_media`  | `productMediaTable`        |
| åª’ä½“æ¨¡å— | `media`          | `mediaTable`               |
| ç”¨æˆ·æ¨¡å— | `user_site_role` | `userSiteRoleTable`        |

**æ³¨æ„äº‹é¡¹**:
- âœ… ä½¿ç”¨ **å•æ•°** å½¢å¼: `site` âŒ `sites`
- âœ… å…¨å°å†™ + ä¸‹åˆ’çº¿åˆ†éš”: `site_category` âŒ `SiteCategory`
- âœ… å…³è”è¡¨: `çˆ¶è¡¨_å­è¡¨` å¦‚ `product_media`
- âœ… ç³»ç»Ÿè¡¨åŠ  `sys_` å‰ç¼€

### 2.2 Drizzle Schema å®šä¹‰

**æ–‡ä»¶**: `packages/contract/src/table.schema.ts`

**å˜é‡å‘½å**: `{camelCase}Table` (å°é©¼å³° + Table åç¼€)

```typescript
// âœ… æ­£ç¡®ç¤ºä¾‹
export const tenantTable = p.pgTable("sys_tenant", { ... });
export const siteTable = p.pgTable("site", { ... });
export const siteCategoryTable = p.pgTable("site_category", { ... });
export const productTable = p.pgTable("product", { ... });
export const productMediaTable = p.pgTable("product_media", { ... });
export const userSiteRoleTable = p.pgTable("user_site_role", { ... });

// âŒ é”™è¯¯ç¤ºä¾‹
export const SitesTable = p.pgTable("sites", { ... });           // âŒ å¤æ•°å½¢å¼
export const site_categoryTable = p.pgTable("site_category", { ... }); // âŒ ä¸‹åˆ’çº¿å˜é‡å
export const SiteCategoryTable = p.pgTable("site_category", { ... });   // âŒ å¤§é©¼å³°å˜é‡å
```

### 2.3 å­—æ®µå‘½åè§„èŒƒ

**è§„åˆ™**: `snake_case` (å…¨å°å†™ + ä¸‹åˆ’çº¿)

```typescript
export const siteCategoryTable = p.pgTable("site_category", {
  id: idUuid,
  name: p.varchar("name", { length: 200 }).notNull(),
  parentId: p.uuid("parent_id"),  // âœ… snake_case
  sortOrder: p.integer("sort_order").default(0),
  isActive: p.boolean("is_active").default(true),
  createdAt: createdAt,
  updatedAt: updatedAt,
});
```

**ç‰¹æ®Šå­—æ®µå‘½å**:
- ä¸»é”®: `id` (uuid)
- å¤–é”®: `{å®ä½“}_id` å¦‚ `parent_id`, `site_id`, `user_id`
- æ—¶é—´æˆ³: `created_at`, `updated_at`
- å¸ƒå°”å€¼: `is_{å½¢å®¹è¯}` å¦‚ `is_active`, `is_public`

---

## 3. å¥‘çº¦å±‚ (Contract)

### 3.1 æ–‡ä»¶å‘½å

**è§„åˆ™**: `{kebab-case}.contract.ts` (è¿å­—ç¬¦åˆ†éš”)

**ä½ç½®**: `packages/contract/src/modules/`

```
packages/contract/src/modules/
â”œâ”€â”€ _custom/                     # ğŸ”´ è‡ªå®šä¹‰æ‰©å±•å¥‘çº¦ï¼ˆæ‰‹åŠ¨ç»´æŠ¤ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼‰
â”‚   â”œâ”€â”€ ads.contract.ts
â”‚   â”œâ”€â”€ auth.contract.ts
â”‚   â”œâ”€â”€ categories.contract.ts
â”‚   â”œâ”€â”€ products.contract.ts
â”‚   â””â”€â”€ ...
â”œâ”€â”€ tenant.contract.ts           # ğŸŸ¢ è‡ªåŠ¨ç”Ÿæˆï¼ˆå‹¿æ‰‹åŠ¨ä¿®æ”¹ï¼‰
â”œâ”€â”€ department.contract.ts       # ğŸŸ¢ è‡ªåŠ¨ç”Ÿæˆï¼ˆå‹¿æ‰‹åŠ¨ä¿®æ”¹ï¼‰
â”œâ”€â”€ site.contract.ts             # ğŸŸ¢ è‡ªåŠ¨ç”Ÿæˆï¼ˆå‹¿æ‰‹åŠ¨ä¿®æ”¹ï¼‰
â”œâ”€â”€ site-category.contract.ts    # ğŸŸ¢ è‡ªåŠ¨ç”Ÿæˆï¼ˆå‹¿æ‰‹åŠ¨ä¿®æ”¹ï¼‰
â”œâ”€â”€ product-media.contract.ts    # ğŸŸ¢ è‡ªåŠ¨ç”Ÿæˆï¼ˆå‹¿æ‰‹åŠ¨ä¿®æ”¹ï¼‰
â”œâ”€â”€ user.contract.ts             # ğŸŸ¢ è‡ªåŠ¨ç”Ÿæˆï¼ˆå‹¿æ‰‹åŠ¨ä¿®æ”¹ï¼‰
â””â”€â”€ index.ts                     # ğŸŸ¢ è‡ªåŠ¨ç”Ÿæˆï¼ˆå‹¿æ‰‹åŠ¨ä¿®æ”¹ï¼‰
```

**æ–‡ä»¶æ ‡è®°è¯´æ˜**ï¼š
- ğŸ”´ **çº¢è‰²** = `_custom/` ç›®å½•ä¸‹çš„è‡ªå®šä¹‰å¥‘çº¦ï¼Œå¯æ‰‹åŠ¨ç¼–è¾‘
- ğŸŸ¢ **ç»¿è‰²** = è‡ªåŠ¨ç”Ÿæˆçš„å¥‘çº¦ï¼Œ**ç¦æ­¢æ‰‹åŠ¨ä¿®æ”¹**ï¼ˆä¼šè¢«è„šæœ¬è¦†ç›–ï¼‰

### 3.2 å¥‘çº¦ç”Ÿæˆæœºåˆ¶

#### è‡ªåŠ¨ç”Ÿæˆæµç¨‹

é¡¹ç›®ä½¿ç”¨ `packages/contract/scripts/gen-all-final.ts` è„šæœ¬è‡ªåŠ¨ç”Ÿæˆå¥‘çº¦ï¼š

```
table.schema.ts (æ•°æ®åº“è¡¨å®šä¹‰)
       â”‚
       â–¼
gen-all-final.ts (ç”Ÿæˆè„šæœ¬)
       â”‚
       â”œâ”€â†’ åˆ†æè¡¨ç»“æ„
       â”œâ”€â†’ ç”ŸæˆåŸºç¡€å¥‘çº¦
       â”œâ”€â†’ æ£€æŸ¥ _custom/ ç›®å½•
       â””â”€â†’ åˆå¹¶è‡ªå®šä¹‰å¥‘çº¦
       â”‚
       â–¼
index.ts (æ›´æ–°ç´¢å¼•)
```

#### ç”Ÿæˆçš„æ ‡å‡†å¥‘çº¦

è„šæœ¬è‡ªåŠ¨ä¸ºæ¯ä¸ªè¡¨ç”Ÿæˆä»¥ä¸‹æ ‡å‡†ç±»å‹ï¼š

```typescript
// è‡ªåŠ¨ç”Ÿæˆçš„å¥‘çº¦ç»“æ„
export const {ModuleName}Contract = {
  // åŸºç¡€å“åº”ç±»å‹
  Response: t.Object({ ... }),

  // CRUD æ“ä½œç±»å‹
  Create: t.Object({ ... }),
  Update: t.Object({ ... }),
  Patch: t.Partial(t.Object({ ... })),

  // æŸ¥è¯¢ç±»å‹
  ListQuery: t.Object({
    search: t.Optional(t.String()),
    page: t.Optional(t.Number()),
    pageSize: t.Optional(t.Number()),
    // ... æ ‡å‡†åˆ†é¡µå‚æ•°
  }),

  ListResponse: t.Object({
    data: t.Array(Response),
    total: t.Number(),
    page: t.Number(),
    pageSize: t.Number(),
  }),
} as const;
```

#### è‡ªå®šä¹‰å¥‘çº¦æ‰©å±•

å½“éœ€è¦æ‰©å±•æ ‡å‡†å¥‘çº¦æ—¶ï¼Œåœ¨ `_custom/` ç›®å½•åˆ›å»ºåŒåæ–‡ä»¶ï¼š

```typescript
// _custom/products.contract.ts
import { t } from "elysia";
import { GeneratedProductContract } from "../generated/product.contract";

// æ‰©å±•ç”Ÿæˆçš„å¥‘çº¦
export const ProductContract = {
  ...GeneratedProductContract,  // ç»§æ‰¿è‡ªåŠ¨ç”Ÿæˆçš„éƒ¨åˆ†

  // è‡ªå®šä¹‰æ‰©å±•
  BulkImport: t.Object({
    url: t.String(),
    mapping: t.Object({ ... }),
  }),

  ExportQuery: t.Object({
    format: t.Union([t.Literal("csv"), t.Literal("excel")]),
    dateRange: t.Optional(t.Object({ ... })),
  }),

  // è¦†ç›–ç”Ÿæˆçš„ç±»å‹ï¼ˆå¦‚éœ€è¦ï¼‰
  Create: t.Object({
    ...GeneratedProductContract.Create.properties,
    customField: t.String(),  // æ·»åŠ è‡ªå®šä¹‰å­—æ®µ
  }),
} as const;
```

**é‡è¦è§„åˆ™**ï¼š
1. `_custom/` ç›®å½•ä¸­çš„å¥‘çº¦ä¼š**è¦†ç›–**è‡ªåŠ¨ç”Ÿæˆçš„åŒåå¥‘çº¦
2. è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬
3. è‡ªå®šä¹‰å¥‘çº¦å¯ä»¥ç»§æ‰¿ç”Ÿæˆå¥‘çº¦ï¼Œé¿å…é‡å¤å®šä¹‰

### 3.3 å¥‘çº¦å¯¼å‡ºå‘½å

**è§„åˆ™**: `{PascalCase}Contract` (å¤§é©¼å³° + Contract åç¼€)

```typescript
// site-category.contract.ts
export const SiteCategoryContract = {
  Response: t.Object({ ... }),
  Create: t.Object({ ... }),
  Update: t.Partial(t.Object({ ... })),
  Patch: t.Partial(t.Object({ ... })),
  ListQuery: t.Object({ ... }),
  ListResponse: t.Object({ ... }),

  // è‡ªå®šä¹‰æ‰©å±•
  TreeResponse: t.Object({ ... }),
  MoveRequest: t.Object({ ... }),
} as const;

export type SiteCategoryContract = InferDTO<typeof SiteCategoryContract>;
```

### 3.4 ç±»å‹å¯¼å‡º

```typescript
// è‡ªåŠ¨æ¨æ–­çš„åŸºç¡€ç±»å‹
export type SiteCategoryContract = InferDTO<typeof SiteCategoryContract>;

// å¸¸ç”¨ç±»å‹åˆ«å
export type SiteCategoryResponse = SiteCategoryContract["Response"];
export type SiteCategoryCreate = SiteCategoryContract["Create"];
export type SiteCategoryUpdate = SiteCategoryContract["Update"];
export type SiteCategoryListQuery = SiteCategoryContract["ListQuery"];
```

---

## 4. æœåŠ¡å±‚ (Service)

### 4.1 æ–‡ä»¶å‘½å

**è§„åˆ™**: `{kebab-case}.service.ts` (è¿å­—ç¬¦åˆ†éš”ï¼Œå¯¹åº”è¡¨åè½¬æ¢)

**ä½ç½®**: `apps/api/src/server/modules/`

```
apps/api/src/server/modules/
â”œâ”€â”€ tenant.service.ts
â”œâ”€â”€ department.service.ts
â”œâ”€â”€ site.service.ts
â”œâ”€â”€ site-category.service.ts      # å¯¹åº” site_category è¡¨
â”œâ”€â”€ product.service.ts
â”œâ”€â”€ product-media.service.ts      # å¯¹åº” product_media è¡¨
â””â”€â”€ user-role.service.ts          # å¯¹åº” user_site_role è¡¨ (å¯ç®€åŒ–)
```

### 4.2 ç±»ä¸å®ä¾‹å‘½å

**è§„åˆ™**:
- ç±»å: `{PascalCase}Service`
- å®ä¾‹: `{camelCase}Service`

```typescript
// site-category.service.ts
export class SiteCategoryService {
  // æ ‡å‡†æ–¹æ³•
  async list(query, ctx) { ... }           // åˆ—è¡¨æŸ¥è¯¢
  async pagelist(query,ctx){...}          // åˆ†é¡µåˆ—è¡¨æŸ¥è¯¢
  async detail(id, ctx) { ... }            // è¯¦æƒ…æŸ¥è¯¢
  async create(body, ctx) { ... }          // åˆ›å»ºæ•°æ®
  async update(id, body, ctx) { ... }      // å…¨é‡æ›´æ–°
  async patch(id, body, ctx) { ... }       // å±€éƒ¨æ›´æ–°
  async delete(id, ctx) { ... }            // åˆ é™¤æ•°æ®

  // è‡ªå®šä¹‰ä¸šåŠ¡æ–¹æ³•
  async tree(ctx) { ... }                  // GET /site-category/tree
  async move(id, newParentId, ctx) { ... } // PATCH /site-category/:id/move
  async patchStatus(id, status, ctx) { ... } // PATCH /site-category/:id/status
}

// å¯¼å‡ºå®ä¾‹ (å°é©¼å³°)
export const siteCategoryService = new SiteCategoryService();
```

### 4.3 æ ‡å‡†æ–¹æ³•ç­¾å

**åŠ¨å®¾ç»“æ„ç»Ÿä¸€è§„èŒƒ**:

| ä¸šåŠ¡åŠ¨ä½œ | Service æ–¹æ³•    | åç«¯è·¯ç”±                | å‰ç«¯ Hook                      |     |
| ---- | ------------- | ------------------- | ---------------------------- | --- |
| åˆ†é¡µåˆ—è¡¨ | `list`        | `GET /`             | `useSiteCategoryList`        |     |
| è¯¦æƒ…æŸ¥è¯¢ | `detail`      | `GET /:id`          | `useSiteCategoryDetail`      |     |
| æ ‘å½¢ç»“æ„ | `tree`        | `GET /tree`         | `useSiteCategoryTree`        |     |
| åˆ›å»ºæ•°æ® | `create`      | `POST /`            | `useCreateSiteCategory`      |     |
| å…¨é‡æ›´æ–° | `update`      | `PUT /:id`          | `useUpdateSiteCategory`      |     |
| å±€éƒ¨ä¿®æ”¹ | `patch`       | `PATCH /:id`        | `usePatchSiteCategory`       |     |
| çŠ¶æ€åˆ‡æ¢ | `patchStatus` | `PATCH /:id/status` | `usePatchSiteCategoryStatus` |     |
| åˆ é™¤æ•°æ® | `delete`      | `DELETE /:id`       | `useDeleteSiteCategory`      |     |

```typescript
class SiteCategoryService {
  // åˆ—è¡¨æŸ¥è¯¢
  async list(
    query: SiteCategoryContract["ListQuery"],
    ctx: ServiceContext
  ): Promise<SiteCategoryContract["ListResponse"]> { ... }

  // è¯¦æƒ…æŸ¥è¯¢
  async detail(
    id: string,
    ctx: ServiceContext
  ): Promise<SiteCategoryContract["Response"]> { ... }

  // åˆ›å»º
  async create(
    body: SiteCategoryContract["Create"],
    ctx: ServiceContext
  ): Promise<SiteCategoryContract["Response"]> { ... }

  // å…¨é‡æ›´æ–°
  async update(
    id: string,
    body: SiteCategoryContract["Update"],
    ctx: ServiceContext
  ): Promise<SiteCategoryContract["Response"]> { ... }

  // å±€éƒ¨æ›´æ–°
  async patch(
    id: string,
    body: SiteCategoryContract["Patch"],
    ctx: ServiceContext
  ): Promise<SiteCategoryContract["Response"]> { ... }

  // åˆ é™¤
  async delete(
    id: string,
    ctx: ServiceContext
  ): Promise<SiteCategoryContract["Response"]> { ... }

  // è‡ªå®šä¹‰æ–¹æ³•å‘½å: åŠ¨è¯ç›´æ¥ä½¿ç”¨ + å¿…è¦å‚æ•°
  async tree(ctx: ServiceContext) { ... }                    // GET /xxx/tree
  async move(id: string, newParentId: string, ctx) { ... }    // PATCH /xxx/:id/move
  async patchStatus(id: string, status: boolean, ctx) { ... } // PATCH /xxx/:id/status
}
```

---

## 5. æ§åˆ¶å™¨å±‚ (Controller)

### 5.1 æ–‡ä»¶å‘½å

**è§„åˆ™**: `{kebab-case}.controller.ts` (è¿å­—ç¬¦åˆ†éš”)

**ä½ç½®**: `apps/api/src/server/controllers/`

```
apps/api/src/server/controllers/
â”œâ”€â”€ tenant.controller.ts
â”œâ”€â”€ department.controller.ts
â”œâ”€â”€ site.controller.ts
â”œâ”€â”€ site-category.controller.ts
â””â”€â”€ user.controller.ts
```

### 5.2 è·¯ç”±ä¸å˜é‡å‘½å

**è§„åˆ™**:
- è·¯ç”± Prefix: `/{kebab-case}` (ä¸æ–‡ä»¶åä¸¥æ ¼ä¸€è‡´)
- å˜é‡å‘½å: `{camelCase}Controller`
- è·¯ç”± Tags: `{PascalCase}` (ç”¨äº OpenAPI åˆ†ç»„)

**âš ï¸ Elysia è·¯ç”±é¡ºåºå…³é”®åŸåˆ™**:

Elysia æŒ‰ç…§è·¯ç”±**å®šä¹‰é¡ºåº**è¿›è¡ŒåŒ¹é…ï¼Œå› æ­¤ï¼š

1. **å›ºå®šè·¯å¾„å¿…é¡»åœ¨åŠ¨æ€è·¯å¾„ä¹‹å‰å®šä¹‰**
   - âœ… æ­£ç¡®: `.get("/tree")` åœ¨ `.get("/:id")` ä¹‹å‰
   - âŒ é”™è¯¯: `.get("/:id")` ä¼šæ•è· `/tree`ï¼Œå°† `tree` å½“ä½œ `id`

2. **æ ‡å‡†è·¯ç”±å®šä¹‰é¡ºåº**:
   ```typescript
   .get("/tree", ...)           // 1. è‡ªå®šä¹‰å›ºå®šè·¯ç”±ï¼ˆå¿…é¡»åœ¨æœ€å‰ï¼‰
   .get("/", ...)               // 2. åˆ—è¡¨è·¯ç”±
   .get("/:id", ...)            // 3. è¯¦æƒ…è·¯ç”±
   .post("/", ...)              // 4. åˆ›å»ºè·¯ç”±
   .put("/:id", ...)            // 5. æ›´æ–°è·¯ç”±
   .patch("/:id", ...)          // 6. éƒ¨åˆ†æ›´æ–°è·¯ç”±
   .delete("/:id", ...)         // 7. åˆ é™¤è·¯ç”±
   .patch("/:id/move", ...)     // 8. è‡ªå®šä¹‰åŠ¨æ€è·¯ç”±
   .patch("/:id/status", ...)   // 9. è‡ªå®šä¹‰åŠ¨æ€è·¯ç”±
   ```

```typescript
// site-category.controller.ts
export const siteCategoryController = new Elysia({
  prefix: "/site-category",  // âœ… ç½‘ç»œè¾¹ç•Œä½¿ç”¨è¿å­—ç¬¦
  tags: ["SiteCategory"],    // âœ… æ–‡æ¡£åˆ†ç»„ä½¿ç”¨å¤§é©¼å³°
})
  .use(dbPlugin)
  .use(betterAuthPlugin)

  // âš ï¸ é‡è¦ï¼šè‡ªå®šä¹‰å›ºå®šè·¯ç”±å¿…é¡»åœ¨åŠ¨æ€è·¯ç”±ä¹‹å‰å®šä¹‰ï¼
  .get("/tree", ...)       // GET /site-category/tree
  .get("/", ...)           // GET /site-category
  .get("/:id", ...)        // GET /site-category/:id

  // åŸºç¡€ CRUD
  .post("/", ...)          // POST /site-category
  .put("/:id", ...)        // PUT /site-category/:id
  .patch("/:id", ...)      // PATCH /site-category/:id
  .delete("/:id", ...)     // DELETE /site-category/:id

  // è‡ªå®šä¹‰åŠ¨æ€è·¯ç”±ï¼ˆåœ¨åŸºç¡€è·¯ç”±ä¹‹åï¼‰
  .patch("/:id/move", ...) // PATCH /site-category/:id/move
  .patch("/:id/status", ...); // PATCH /site-category/:id/status
```

### 5.3 Prefix æ˜ å°„è¡¨

| æ•°æ®åº“è¡¨ | æ–‡ä»¶å | å˜é‡å‘½å | è·¯ç”± Prefix | ç¤ºä¾‹è·¯ç”± |
|---------|-------|---------|------------|---------|
| `site` | `site.controller.ts` | `siteController` | `/site` | `GET /site` |
| `site_category` | `site-category.controller.ts` | `siteCategoryController` | `/site-category` | `GET /site-category` |
| `product_media` | `product-media.controller.ts` | `productMediaController` | `/product-media` | `GET /product-media` |
| `user_site_role` | `user-role.controller.ts` | `userRoleController` | `/user-role` | `GET /user-role` |

**è½¬æ¢è§„åˆ™**:
1. è¡¨å `site_category` â†’ å»ä¸‹åˆ’çº¿è½¬å°é©¼å³° `siteCategory`
2. æ–‡ä»¶ååŠ è¿å­—ç¬¦ `site-category.controller.ts`
3. è·¯ç”±åŠ å‰ç¼€ `/site-category`
4. å…³è”è¡¨å¯é€‰ç®€åŒ–: `user_site_role` â†’ `user-role`

### 5.4 æ§åˆ¶å™¨å®Œæ•´ç¤ºä¾‹

```typescript
// site-category.controller.ts
import { Elysia, t } from "elysia";
import { siteCategoryService } from "../modules/site-category.service";
import { SiteCategoryContract } from "@repo/contract";

export const siteCategoryController = new Elysia({
  prefix: "/site-category",
  tags: ["SiteCategory"],
})
  .use(dbPlugin)
  .use(betterAuthPlugin)

  // âš ï¸ é‡è¦ï¼šè‡ªå®šä¹‰è·¯ç”±å¿…é¡»åœ¨åŠ¨æ€è·¯ç”±ä¹‹å‰å®šä¹‰ï¼
  // GET /site-category/tree - è·å–æ ‘å½¢ç»“æ„
  .get("/tree", async ({ userInfo, db }) => {
    return siteCategoryService.tree({ db, userInfo });
  }, {
    auth: true,
    detail: {
      summary: "è·å–ç«™ç‚¹åˆ†ç±»æ ‘å½¢ç»“æ„",
      tags: ["SiteCategory"],
    },
  })

  // GET /site-category/ - è·å–åˆ—è¡¨
  .get("/", async ({ query, userInfo, db }) => {
    return siteCategoryService.list(query, { db, userInfo });
  }, {
    auth: true,
    query: SiteCategoryContract.ListQuery,
    detail: {
      summary: "è·å–ç«™ç‚¹åˆ†ç±»åˆ—è¡¨",
      description: "åˆ†é¡µæŸ¥è¯¢ç«™ç‚¹åˆ†ç±»æ•°æ®ï¼Œæ”¯æŒæœç´¢å’Œæ’åº",
      tags: ["SiteCategory"],
    },
  })

  // GET /site-category/:id - è·å–è¯¦æƒ…
  .get("/:id", async ({ params, userInfo, db }) => {
    return siteCategoryService.detail(params.id, { db, userInfo });
  }, {
    auth: true,
    params: t.Object({ id: t.String() }),
    detail: {
      summary: "è·å–ç«™ç‚¹åˆ†ç±»è¯¦æƒ…",
      tags: ["SiteCategory"],
    },
  })

  // POST /site-category - åˆ›å»º
  .post("/", async ({ body, userInfo, db }) => {
    return siteCategoryService.create(body, { db, userInfo });
  }, {
    auth: true,
    body: SiteCategoryContract.Create,
    detail: {
      summary: "åˆ›å»ºç«™ç‚¹åˆ†ç±»",
      tags: ["SiteCategory"],
    },
  })

  // PUT /site-category/:id - å…¨é‡æ›´æ–°
  .put("/:id", async ({ params, body, userInfo, db }) => {
    return siteCategoryService.update(params.id, body, { db, userInfo });
  }, {
    auth: true,
    body: SiteCategoryContract.Update,
    detail: {
      summary: "æ›´æ–°ç«™ç‚¹åˆ†ç±»",
      tags: ["SiteCategory"],
    },
  })

  // PATCH /site-category/:id - å±€éƒ¨æ›´æ–°
  .patch("/:id", async ({ params, body, userInfo, db }) => {
    return siteCategoryService.patch(params.id, body, { db, userInfo });
  }, {
    auth: true,
    body: SiteCategoryContract.Patch,
    detail: {
      summary: "éƒ¨åˆ†æ›´æ–°ç«™ç‚¹åˆ†ç±»",
      tags: ["SiteCategory"],
    },
  })

  // DELETE /site-category/:id - åˆ é™¤
  .delete("/:id", async ({ params, userInfo, db }) => {
    return siteCategoryService.delete(params.id, { db, userInfo });
  }, {
    auth: true,
    detail: {
      summary: "åˆ é™¤ç«™ç‚¹åˆ†ç±»",
      tags: ["SiteCategory"],
    },
  })

  // PATCH /site-category/:id/move - ç§»åŠ¨åˆ†ç±»
  .patch("/:id/move", async ({ params, body, userInfo, db }) => {
    return siteCategoryService.move(params.id, body.newParentId, { db, userInfo });
  }, {
    auth: true,
    body: t.Object({ newParentId: t.Optional(t.String()) }),
    detail: {
      summary: "ç§»åŠ¨ç«™ç‚¹åˆ†ç±»",
      tags: ["SiteCategory"],
    },
  })

  // PATCH /site-category/:id/status - åˆ‡æ¢çŠ¶æ€
  .patch("/:id/status", async ({ params, body, userInfo, db }) => {
    return siteCategoryService.patchStatus(params.id, body.isActive, { db, userInfo });
  }, {
    auth: true,
    body: t.Object({ isActive: t.Boolean() }),
    detail: {
      summary: "åˆ‡æ¢ç«™ç‚¹åˆ†ç±»çŠ¶æ€",
      tags: ["SiteCategory"],
    },
  });
```

---

## 6. å‰ç«¯ API Hooks

### 6.1 æ–‡ä»¶å‘½å

**è§„åˆ™**: `{kebab-case}.ts` (è¿å­—ç¬¦åˆ†éš”ï¼Œå¯¹åº”åç«¯è·¯ç”±)

**ä½ç½®**: `apps/api/src/hooks/api/`

```
apps/api/src/hooks/api/
â”œâ”€â”€ tenant.ts
â”œâ”€â”€ department.ts
â”œâ”€â”€ site.ts
â”œâ”€â”€ site-category.ts         # å¯¹åº” /site-category è·¯ç”±
â”œâ”€â”€ product.ts
â”œâ”€â”€ product-media.ts         # å¯¹åº” /product-media è·¯ç”±
â””â”€â”€ user-role.ts             # å¯¹åº” /user-role è·¯ç”±
```

### 6.2 ç±»å‹æ–‡ä»¶ (å¯é€‰)

**è§„åˆ™**: `{kebab-case}.type.ts` (ç”¨äºå‰ç«¯è‡ªå®šä¹‰ç±»å‹æ‰©å±•)

```
apps/api/src/hooks/api/
â”œâ”€â”€ site-category.ts
â”œâ”€â”€ site-category.type.ts    # å‰ç«¯æ‰©å±•ç±»å‹
â”œâ”€â”€ user.ts
â””â”€â”€ user.type.ts             # å‰ç«¯æ‰©å±•ç±»å‹
```

### 6.3 Hook å‘½åè§„èŒƒ

**å‘½åæ¨¡å¼**:
- Query (è¯»): `use{PascalCase}{Action}` å¦‚ `useSiteCategoryList`, `useSiteCategoryTree`
- Mutation (å†™): `use{Action}{PascalCase}` å¦‚ `useCreateSiteCategory`, `useUpdateSiteCategory`

```typescript
// site-category.ts
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import type { SiteCategoryContract } from "@repo/contract";

// Query Key å·¥å‚
const keys = {
  all: ["site-category"] as const,
  lists: () => [...keys.all, "list"] as const,
  detail: (id: string) => [...keys.all, "detail", id] as const,
  tree: () => [...keys.all, "tree"] as const,
};

// Query Hooks (è·å–æ•°æ®)
export function useSiteCategoryList(
  params?: SiteCategoryContract["ListQuery"],
  enabled = true
) {
  return useQuery({
    queryKey: keys.lists(),
    queryFn: () => api.get<SiteCategoryContract["ListResponse"]>("/api/v1/site-category", params),
    enabled,
  });
}

export function useSiteCategoryDetail(
  id: string,
  enabled = true
) {
  return useQuery({
    queryKey: keys.detail(id),
    queryFn: () => api.get<SiteCategoryContract["Response"]>(`/api/v1/site-category/${id}`),
    enabled: enabled && !!id,
  });
}

export function useSiteCategoryTree(enabled = true) {
  return useQuery({
    queryKey: keys.tree(),
    queryFn: () => api.get<SiteCategoryContract["TreeResponse"][]>("/api/v1/site-category/tree"),
    enabled,
  });
}

// Mutation Hooks (ä¿®æ”¹æ•°æ®)
export function useCreateSiteCategory() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: (data: SiteCategoryContract["Create"]) =>
      api.post<SiteCategoryContract["Response"]>("/api/v1/site-category", data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: keys.all });
    },
  });
}

export function useUpdateSiteCategory() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, data }: { id: string; data: SiteCategoryContract["Update"] }) =>
      api.put<SiteCategoryContract["Response"]>(`/api/v1/site-category/${id}`, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: keys.all });
    },
  });
}

export function usePatchSiteCategory() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, data }: { id: string; data: SiteCategoryContract["Patch"] }) =>
      api.patch<SiteCategoryContract["Response"]>(`/api/v1/site-category/${id}`, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: keys.all });
    },
  });
}

export function useDeleteSiteCategory() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: (id: string) =>
      api.delete<SiteCategoryContract["Response"]>(`/api/v1/site-category/${id}`),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: keys.all });
    },
  });
}

// è‡ªå®šä¹‰ä¸šåŠ¡ Hooks
export function useMoveSiteCategory() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, newParentId }: { id: string; newParentId?: string }) =>
      api.patch(`/api/v1/site-category/${id}/move`, { newParentId }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: keys.all });
    },
  });
}

export function usePatchSiteCategoryStatus() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, isActive }: { id: string; isActive: boolean }) =>
      api.patch(`/api/v1/site-category/${id}/status`, { isActive }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: keys.all });
    },
  });
}
```

### 6.4 åŠ¨è¯å¯¹ç…§è¡¨

| æ“ä½œ | Query Hook | Mutation Hook | åç«¯è·¯ç”± |
|-----|-----------|--------------|---------|
| åˆ—è¡¨ | `use{Entity}List` | - | `GET /` |
| è¯¦æƒ… | `use{Entity}Detail` | - | `GET /:id` |
| åˆ›å»º | - | `useCreate{Entity}` | `POST /` |
| å…¨é‡æ›´æ–° | - | `useUpdate{Entity}` | `PUT /:id` |
| å±€éƒ¨æ›´æ–° | - | `usePatch{Entity}` | `PATCH /:id` |
| åˆ é™¤ | - | `useDelete{Entity}` | `DELETE /:id` |
| æ‰¹é‡åˆ é™¤ | - | `useBatchDelete{Entities}` | `DELETE /batch` |
| è‡ªå®šä¹‰æ“ä½œ | `use{Entity}{Custom}` | `use{Custom}{Entity}` | è‡ªå®šä¹‰ |

### 6.5 Query Key è§„èŒƒ

```typescript
// âœ… æ ‡å‡†æ ¼å¼
const keys = {
  all: ["kebab-entity"] as const,
  lists: () => [...keys.all, "list"] as const,
  detail: (id: string) => [...keys.all, "detail", id] as const,
};

// ç¤ºä¾‹
["site-category", "list", { page: 1 }]
["site-category", "detail", "123"]
["site-category", "tree"]
["product-media", "search", { keyword: "phone" }]
```

---

## 7. æƒé™å‘½å

### 7.1 æƒé™å¸¸é‡æ ¼å¼

**è§„åˆ™**: `{MODULE}_{ACTION}` (å…¨å¤§å†™ + ä¸‹åˆ’çº¿)

```typescript
export const PERMISSIONS = {
  // åŸºç¡€ CRUD
  SITE_CATEGORY_VIEW: "SITE_CATEGORY_VIEW",
  SITE_CATEGORY_CREATE: "SITE_CATEGORY_CREATE",
  SITE_CATEGORY_EDIT: "SITE_CATEGORY_EDIT",
  SITE_CATEGORY_DELETE: "SITE_CATEGORY_DELETE",

  // ç‰¹æ®Šæƒé™
  SITE_CATEGORY_MANAGE: "SITE_CATEGORY_MANAGE",
  PRODUCT_MEDIA_UPLOAD: "PRODUCT_MEDIA_UPLOAD",

  // ç³»ç»Ÿæƒé™
  SITES_MANAGE: "SITES_MANAGE",
  TENANTS_MANAGE: "TENANTS_MANAGE",
  SUPER: "*",
} as const;
```

### 7.2 æ¨¡å—æ˜ å°„è¡¨

| æ•°æ®åº“è¡¨ | æ–‡ä»¶å | æƒé™å‰ç¼€ | ç¤ºä¾‹æƒé™ |
|---------|-------|---------|----------|
| `site` | `site.ts` | `SITE` | `SITE_VIEW`, `SITE_CREATE` |
| `site_category` | `site-category.ts` | `SITE_CATEGORY` | `SITE_CATEGORY_VIEW`, `SITE_CATEGORY_EDIT` |
| `product` | `product.ts` | `PRODUCT` | `PRODUCT_VIEW`, `PRODUCT_DELETE` |
| `product_media` | `product-media.ts` | `PRODUCT_MEDIA` | `PRODUCT_MEDIA_UPLOAD` |
| `user_site_role` | `user-role.ts` | `USER_ROLE` | `USER_ROLE_VIEW` |

**è½¬æ¢è§„åˆ™**:
1. è¡¨å `site_category` â†’ æ–‡ä»¶å `site-category`
2. æ–‡ä»¶å `site-category` â†’ æƒé™å‰ç¼€ `SITE_CATEGORY` (è¿å­—ç¬¦è½¬ä¸‹åˆ’çº¿ï¼Œå…¨å¤§å†™)
3. å…³è”è¡¨å¯é€‰ç®€åŒ–: `user_site_role` â†’ `user-role` â†’ `USER_ROLE`

---

## 8. å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹: ç«™ç‚¹åˆ†ç±» (Site Category)

#### 8.1 æ•°æ®åº“å±‚

```typescript
// packages/contract/src/table.schema.ts
export const siteCategoryTable = p.pgTable("site_category", {
  id: idUuid,
  name: p.varchar("name", { length: 200 }).notNull(),
  description: p.text("description"),
  parentId: p.uuid("parent_id").references(() => siteCategoryTable.id),
  sortOrder: p.integer("sort_order").default(0),
  isActive: p.boolean("is_active").default(true),
  tenantId: p.uuid("tenant_id").references(() => tenantTable.id),
  deptId: p.uuid("dept_id").references(() => deptTable.id),
  createdAt: createdAt,
  updatedAt: updatedAt,
});
```

#### 8.2 å¥‘çº¦å±‚

```typescript
// packages/contract/src/modules/site-category.contract.ts
import { t } from "elysia";
import { type InferDTO, spread } from "../helper/utils";
import { siteCategoryTable } from "../table.schema";

export const SiteCategoryFields = spread(siteCategoryTable, "select");

export const SiteCategoryContract = {
  Response: t.Object({ ...SiteCategoryFields }),
  Create: t.Object({
    name: t.String(),
    description: t.Optional(t.String()),
    parentId: t.Optional(t.String()),
    sortOrder: t.Optional(t.Number()),
    isActive: t.Optional(t.Boolean()),
  }),
  Update: t.Object({
    name: t.String(),
    description: t.Optional(t.String()),
    parentId: t.Optional(t.String()),
    sortOrder: t.Optional(t.Number()),
    isActive: t.Optional(t.Boolean()),
  }),
  Patch: t.Partial(t.Object({
    name: t.String(),
    description: t.String(),
    parentId: t.String(),
    sortOrder: t.Number(),
    isActive: t.Boolean(),
  })),
  ListQuery: t.Object({
    search: t.Optional(t.String()),
    page: t.Optional(t.Number()),
    pageSize: t.Optional(t.Number()),
  }),
  ListResponse: t.Object({
    data: t.Array(t.Object({ ...SiteCategoryFields })),
    total: t.Number(),
    page: t.Number(),
    pageSize: t.Number(),
  }),
  // è‡ªå®šä¹‰æ‰©å±•
  TreeResponse: t.Object({
    ...SiteCategoryFields,
    children: t.Optional(t.Array(t.Any())),
  }),
} as const;

export type SiteCategoryContract = InferDTO<typeof SiteCategoryContract>;
```

#### 8.3 æœåŠ¡å±‚

```typescript
// apps/api/src/server/modules/site-category.service.ts
import { db } from "@/db";
import { siteCategoryTable } from "@repo/contract";
import type { SiteCategoryContract } from "@repo/contract";

export class SiteCategoryService {
  async list(query: SiteCategoryContract["ListQuery"], ctx: ServiceContext) {
    const { search, page = 1, pageSize = 20 } = query;
    const scope = ctx.getScope();

    const where = {
      tenantId: scope.tenantId,
      deptId: scope.deptId,
      ...(search ? { name: { ilike: `%${search}%` } } : {}),
    };

    const [data, totalResult] = await Promise.all([
      db.query.siteCategoryTable.findMany({
        where,
        orderBy: { sortOrder: "asc" },
        limit: pageSize,
        offset: (page - 1) * pageSize,
      }),
      db.select({ count: sql<number>`count(*)::int` })
        .from(siteCategoryTable)
        .where(where),
    ]);

    return {
      data,
      total: totalResult[0].count,
      page,
      pageSize,
    };
  }

  async detail(id: string, ctx: ServiceContext) {
    const scope = ctx.getScope();
    return db.query.siteCategoryTable.findFirst({
      where: {
        id,
        tenantId: scope.tenantId,
        deptId: scope.deptId,
      },
    });
  }

  async create(body: SiteCategoryContract["Create"], ctx: ServiceContext) {
    const scope = ctx.getScope();
    const result = await db.insert(siteCategoryTable)
      .values({
        ...body,
        tenantId: scope.tenantId,
        deptId: scope.deptId,
      })
      .returning();

    return result[0];
  }

  async update(id: string, body: SiteCategoryContract["Update"], ctx: ServiceContext) {
    const scope = ctx.getScope();
    const result = await db.update(siteCategoryTable)
      .set({
        ...body,
        updatedAt: new Date(),
      })
      .where(
        and(
          eq(siteCategoryTable.id, id),
          eq(siteCategoryTable.tenantId, scope.tenantId),
          eq(siteCategoryTable.deptId, scope.deptId)
        )
      )
      .returning();

    return result[0];
  }

  async patch(id: string, body: SiteCategoryContract["Patch"], ctx: ServiceContext) {
    return this.update(id, body as any, ctx);
  }

  async delete(id: string, ctx: ServiceContext) {
    const scope = ctx.getScope();
    const result = await db.delete(siteCategoryTable)
      .where(
        and(
          eq(siteCategoryTable.id, id),
          eq(siteCategoryTable.tenantId, scope.tenantId),
          eq(siteCategoryTable.deptId, scope.deptId)
        )
      )
      .returning();

    return result[0];
  }

  async tree(ctx: ServiceContext) {
    const scope = ctx.getScope();
    const categories = await db.query.siteCategoryTable.findMany({
      where: {
        tenantId: scope.tenantId,
        deptId: scope.deptId,
        isActive: true,
      },
      orderBy: { sortOrder: "asc" },
    });

    // æ„å»ºæ ‘å½¢ç»“æ„
    const buildTree = (parentId: string | null = null) => {
      return categories
        .filter(cat => cat.parentId === parentId)
        .map(cat => ({
          ...cat,
          children: buildTree(cat.id),
        }));
    };

    return buildTree();
  }

  async move(id: string, newParentId: string | null, ctx: ServiceContext) {
    const scope = ctx.getScope();
    const result = await db.update(siteCategoryTable)
      .set({ parentId: newParentId, updatedAt: new Date() })
      .where(
        and(
          eq(siteCategoryTable.id, id),
          eq(siteCategoryTable.tenantId, scope.tenantId),
          eq(siteCategoryTable.deptId, scope.deptId)
        )
      )
      .returning();

    return result[0];
  }

  async patchStatus(id: string, isActive: boolean, ctx: ServiceContext) {
    const scope = ctx.getScope();
    const result = await db.update(siteCategoryTable)
      .set({ isActive, updatedAt: new Date() })
      .where(
        and(
          eq(siteCategoryTable.id, id),
          eq(siteCategoryTable.tenantId, scope.tenantId),
          eq(siteCategoryTable.deptId, scope.deptId)
        )
      )
      .returning();

    return result[0];
  }
}

export const siteCategoryService = new SiteCategoryService();
```

#### 8.4 æ§åˆ¶å™¨å±‚

```typescript
// apps/api/src/server/controllers/site-category.controller.ts
import { Elysia, t } from "elysia";
import { siteCategoryService } from "../modules/site-category.service";
import { SiteCategoryContract } from "@repo/contract";
import { PERMISSIONS } from "@/config/permissions";

export const siteCategoryController = new Elysia({
  prefix: "/site-category",
  tags: ["SiteCategory"],
})
  .use(dbPlugin)
  .use(betterAuthPlugin)

  // âš ï¸ é‡è¦ï¼šè‡ªå®šä¹‰è·¯ç”±å¿…é¡»åœ¨åŠ¨æ€è·¯ç”±ä¹‹å‰å®šä¹‰ï¼
  // GET /site-category/tree - è·å–æ ‘å½¢ç»“æ„
  .get("/tree", async ({ userInfo, db }) => {
    return siteCategoryService.tree({ db, userInfo });
  }, {
    auth: true,
    detail: {
      summary: "è·å–ç«™ç‚¹åˆ†ç±»æ ‘å½¢ç»“æ„",
      tags: ["SiteCategory"],
    },
  })

  // GET /site-category/ - è·å–åˆ—è¡¨
  .get("/", async ({ query, userInfo, db }) => {
    return siteCategoryService.list(query, { db, userInfo });
  }, {
    auth: true,
    query: SiteCategoryContract.ListQuery,
    detail: {
      summary: "è·å–ç«™ç‚¹åˆ†ç±»åˆ—è¡¨",
      description: "åˆ†é¡µæŸ¥è¯¢ç«™ç‚¹åˆ†ç±»æ•°æ®ï¼Œæ”¯æŒæœç´¢å’Œæ’åº",
      tags: ["SiteCategory"],
    },
  })

  // GET /site-category/:id - è·å–è¯¦æƒ…
  .get("/:id", async ({ params, userInfo, db }) => {
    return siteCategoryService.detail(params.id, { db, userInfo });
  }, {
    auth: true,
    params: t.Object({ id: t.String() }),
    detail: {
      summary: "è·å–ç«™ç‚¹åˆ†ç±»è¯¦æƒ…",
      tags: ["SiteCategory"],
    },
  })

  // POST /site-category - åˆ›å»º
  .post("/", async ({ body, userInfo, db }) => {
    return siteCategoryService.create(body, { db, userInfo });
  }, {
    auth: true,
    body: SiteCategoryContract.Create,
    detail: {
      summary: "åˆ›å»ºç«™ç‚¹åˆ†ç±»",
      tags: ["SiteCategory"],
    },
  })

  // PUT /site-category/:id - å…¨é‡æ›´æ–°
  .put("/:id", async ({ params, body, userInfo, db }) => {
    return siteCategoryService.update(params.id, body, { db, userInfo });
  }, {
    auth: true,
    body: SiteCategoryContract.Update,
    detail: {
      summary: "æ›´æ–°ç«™ç‚¹åˆ†ç±»",
      tags: ["SiteCategory"],
    },
  })

  // PATCH /site-category/:id - å±€éƒ¨æ›´æ–°
  .patch("/:id", async ({ params, body, userInfo, db }) => {
    return siteCategoryService.patch(params.id, body, { db, userInfo });
  }, {
    auth: true,
    body: SiteCategoryContract.Patch,
    detail: {
      summary: "éƒ¨åˆ†æ›´æ–°ç«™ç‚¹åˆ†ç±»",
      tags: ["SiteCategory"],
    },
  })

  // DELETE /site-category/:id - åˆ é™¤
  .delete("/:id", async ({ params, userInfo, db }) => {
    return siteCategoryService.delete(params.id, { db, userInfo });
  }, {
    auth: true,
    detail: {
      summary: "åˆ é™¤ç«™ç‚¹åˆ†ç±»",
      tags: ["SiteCategory"],
    },
  })

  // PATCH /site-category/:id/move - ç§»åŠ¨åˆ†ç±»
  .patch("/:id/move", async ({ params, body, userInfo, db }) => {
    return siteCategoryService.move(params.id, body.newParentId, { db, userInfo });
  }, {
    auth: true,
    body: t.Object({ newParentId: t.Optional(t.String()) }),
    detail: {
      summary: "ç§»åŠ¨ç«™ç‚¹åˆ†ç±»",
      tags: ["SiteCategory"],
    },
  })

  // PATCH /site-category/:id/status - åˆ‡æ¢çŠ¶æ€
  .patch("/:id/status", async ({ params, body, userInfo, db }) => {
    return siteCategoryService.patchStatus(params.id, body.isActive, { db, userInfo });
  }, {
    auth: true,
    body: t.Object({ isActive: t.Boolean() }),
    detail: {
      summary: "åˆ‡æ¢ç«™ç‚¹åˆ†ç±»çŠ¶æ€",
      tags: ["SiteCategory"],
    },
  });
```

#### 8.5 å‰ç«¯ Hooks

```typescript
// apps/api/src/hooks/api/site-category.ts
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import type { SiteCategoryContract } from "@repo/contract";

// Query Key å·¥å‚
const keys = {
  all: ["site-category"] as const,
  lists: () => [...keys.all, "list"] as const,
  detail: (id: string) => [...keys.all, "detail", id] as const,
  tree: () => [...keys.all, "tree"] as const,
};

// Query Hooks
export function useSiteCategoryList(
  params?: SiteCategoryContract["ListQuery"],
  enabled = true
) {
  return useQuery({
    queryKey: keys.lists(),
    queryFn: () => api.get<SiteCategoryContract["ListResponse"]>("/api/v1/site-category", params),
    enabled,
  });
}

export function useSiteCategoryDetail(id: string, enabled = true) {
  return useQuery({
    queryKey: keys.detail(id),
    queryFn: () => api.get<SiteCategoryContract["Response"]>(`/api/v1/site-category/${id}`),
    enabled: enabled && !!id,
  });
}

export function useSiteCategoryTree(enabled = true) {
  return useQuery({
    queryKey: keys.tree(),
    queryFn: () => api.get<SiteCategoryContract["TreeResponse"][]>("/api/v1/site-category/tree"),
    enabled,
  });
}

// Mutation Hooks
export function useCreateSiteCategory() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: (data: SiteCategoryContract["Create"]) =>
      api.post<SiteCategoryContract["Response"]>("/api/v1/site-category", data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: keys.all });
    },
  });
}

export function useUpdateSiteCategory() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, data }: { id: string; data: SiteCategoryContract["Update"] }) =>
      api.put<SiteCategoryContract["Response"]>(`/api/v1/site-category/${id}`, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: keys.all });
    },
  });
}

export function usePatchSiteCategory() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, data }: { id: string; data: SiteCategoryContract["Patch"] }) =>
      api.patch<SiteCategoryContract["Response"]>(`/api/v1/site-category/${id}`, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: keys.all });
    },
  });
}

export function useDeleteSiteCategory() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: (id: string) =>
      api.delete<SiteCategoryContract["Response"]>(`/api/v1/site-category/${id}`),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: keys.all });
    },
  });
}

export function useMoveSiteCategory() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, newParentId }: { id: string; newParentId?: string }) =>
      api.patch(`/api/v1/site-category/${id}/move`, { newParentId }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: keys.all });
    },
  });
}

export function usePatchSiteCategoryStatus() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, isActive }: { id: string; isActive: boolean }) =>
      api.patch(`/api/v1/site-category/${id}/status`, { isActive }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: keys.all });
    },
  });
}
```

#### 8.6 æƒé™é…ç½®

```typescript
// apps/api/src/server/config/permissions.ts
export const PERMISSIONS = {
  // ç«™ç‚¹åˆ†ç±»æ¨¡å—
  SITE_CATEGORY_VIEW: "SITE_CATEGORY_VIEW",
  SITE_CATEGORY_CREATE: "SITE_CATEGORY_CREATE",
  SITE_CATEGORY_EDIT: "SITE_CATEGORY_EDIT",
  SITE_CATEGORY_DELETE: "SITE_CATEGORY_DELETE",

  // å…¶ä»–æ¨¡å—...
} as const;

// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨
import { PERMISSIONS } from "@/config/permissions";

// åœ¨è·¯ç”±é…ç½®ä¸­
detail: {
  summary: "è·å–ç«™ç‚¹åˆ†ç±»åˆ—è¡¨",
  tags: ["SiteCategory"],
  security: [{ BearerAuth: [PERMISSIONS.SITE_CATEGORY_VIEW] }],
}
```

---

## 9. è‡ªåŠ¨åŒ–è½¬æ¢è§„åˆ™

### 9.1 å®Œæ•´æ˜ å°„è¡¨

å½“è¾“å…¥æ¨¡å—åä¸º `site-category` (æ–‡ä»¶å/è·¯ç”±å) æ—¶ï¼š

| ç›®æ ‡å±‚çº§ | è½¬æ¢é€»è¾‘ | ç»“æœç¤ºä¾‹ |
|---------|---------|---------|
| **æ•°æ®åº“è¡¨å** | `toSnakeCase(input)` | `site_category` |
| **Schema å˜é‡** | `toCamelCase(table)` + `Table` | `siteCategoryTable` |
| **æ–‡ä»¶å** | `input` + `.type.ts` | `site-category.contract.ts` |
| **URL è·¯å¾„** | `/` + `input` | `/site-category` |
| **ä»£ç å˜é‡** | `toCamelCase(input)` | `siteCategory` |
| **ç±»å‹/ç±»å** | `toPascalCase(input)` + `Type` | `SiteCategoryContract` |
| **æƒé™å‰ç¼€** | `toUpperSnake(input)` | `SITE_CATEGORY` |

### 9.2 æ ¸å¿ƒè½¬æ¢ç®—æ³• (TypeScript)

```typescript
/**
 * è¿å­—ç¬¦è½¬é©¼å³° (kebab-case â†’ camelCase)
 * site-category â†’ siteCategory
 */
function toCamelCase(str: string): string {
  return str.replace(/-([a-z])/g, (_, c) => c.toUpperCase());
}

/**
 * é©¼å³°è½¬å¤§é©¼å³° (camelCase â†’ PascalCase)
 * siteCategory â†’ SiteCategory
 */
function toPascalCase(str: string): string {
  return str.charAt(0).toUpperCase() + toCamelCase(str.slice(1));
}

/**
 * è¿å­—ç¬¦è½¬ä¸‹åˆ’çº¿ (kebab-case â†’ snake_case)
 * site-category â†’ site_category
 */
function toSnakeCase(str: string): string {
  return str.replace(/-/g, '_');
}

/**
 * è¿å­—ç¬¦è½¬å¤§å†™ä¸‹åˆ’çº¿ (kebab-case â†’ UPPER_SNAKE_CASE)
 * site-category â†’ SITE_CATEGORY
 */
function toUpperSnake(str: string): string {
  return toSnakeCase(str).toUpperCase();
}

/**
 * ä¸‹åˆ’çº¿è½¬é©¼å³° (snake_case â†’ camelCase)
 * site_category â†’ siteCategory
 */
function snakeToCamel(str: string): string {
  return str.replace(/_([a-z])/g, (_, c) => c.toUpperCase());
}

/**
 * ä¸‹åˆ’çº¿è½¬è¿å­—ç¬¦ (snake_case â†’ kebab-case)
 * site_category â†’ site-category
 */
function snakeToKebab(str: string): string {
  return str.replace(/_/g, '-');
}

// ä½¿ç”¨ç¤ºä¾‹
const moduleName = "site-category";

console.log(toCamelCase(moduleName));        // "siteCategory"
console.log(toPascalCase(moduleName));       // "SiteCategory"
console.log(toSnakeCase(moduleName));        // "site_category"
console.log(toUpperSnake(moduleName));       // "SITE_CATEGORY"

const tableName = "site_category";
console.log(snakeToCamel(tableName));        // "siteCategory"
console.log(snakeToKebab(tableName));        // "site-category"
```

### 9.3 è‡ªåŠ¨æ¨å¯¼ç¤ºä¾‹

ä»**æ•°æ®åº“è¡¨å**æ¨å¯¼æ‰€æœ‰å±‚çº§:

```typescript
// è¾“å…¥: "site_category"
const tableName = "site_category";

// 1. æ•°æ®åº“å±‚
const table = tableName;  // "site_category"

// 2. Schema å˜é‡
const schemaVar = snakeToCamel(tableName) + "Table";  // "siteCategoryTable"

// 3. æ–‡ä»¶å (å¥‘çº¦/æœåŠ¡/æ§åˆ¶å™¨)
const fileName = snakeToKebab(tableName);  // "site-category"

// 4. URL è·¯ç”±
const routePrefix = "/" + fileName;  // "/site-category"

// 5. ä»£ç å˜é‡ (æœåŠ¡/æ§åˆ¶å™¨å®ä¾‹)
const codeVar = snakeToCamel(tableName);  // "siteCategory"

// 6. ç±»å‹å (å¥‘çº¦/æœåŠ¡ç±»)
const typeName = snakeToCamel(tableName).split('').map((c, i) =>
  i === 0 ? c.toUpperCase() : c
).join('');  // "SiteCategory"

// 7. æƒé™å‰ç¼€
const permissionPrefix = tableName.toUpperCase();  // "SITE_CATEGORY"
```

---

## 10. æ€»ç»“

### 10.1 ä¸€è‡´æ€§æ£€æŸ¥æ¸…å•

å¼€å‘æ—¶è¯·å¯¹ç…§ä»¥ä¸‹æ¸…å•è¿›è¡Œæ£€æŸ¥ï¼š

#### æ•°æ®åº“å±‚
- [ ] æ•°æ®åº“è¡¨ä½¿ç”¨ `snake_case` + **å•æ•°** å½¢å¼
- [ ] Schema å˜é‡ä½¿ç”¨ `camelCase` + `Table` åç¼€
- [ ] å­—æ®µåä½¿ç”¨ `snake_case`
- [ ] å¤–é”®å­—æ®µæ ¼å¼ä¸º `{å®ä½“}_id`

#### å¥‘çº¦å±‚
- [ ] æ–‡ä»¶åä½¿ç”¨ `kebab-case` + `.contract.ts` åç¼€
- [ ] å¥‘çº¦å¯¼å‡ºä½¿ç”¨ `PascalCase` + `Contract` åç¼€
- [ ] ç±»å‹å¯¼å‡ºä½¿ç”¨ `PascalCase` + `DTO` åç¼€

#### æœåŠ¡å±‚
- [ ] æ–‡ä»¶åä½¿ç”¨ `kebab-case` + `.service.ts` åç¼€
- [ ] ç±»åä½¿ç”¨ `PascalCase` + `Service` åç¼€
- [ ] å®ä¾‹ä½¿ç”¨ `camelCase` + `Service` åç¼€
- [ ] æ–¹æ³•åéµå¾ªåŠ¨å®¾ç»“æ„ (list, detail, create, update, patch, delete)

#### æ§åˆ¶å™¨å±‚
- [ ] æ–‡ä»¶åä½¿ç”¨ `kebab-case` + `.controller.ts` åç¼€
- [ ] å˜é‡ä½¿ç”¨ `camelCase` + `Controller` åç¼€
- [ ] è·¯ç”± prefix ä½¿ç”¨ `/{kebab-case}` æ ¼å¼
- [ ] è·¯ç”± tags ä½¿ç”¨ `PascalCase` æ ¼å¼

#### å‰ç«¯å±‚
- [ ] Hook æ–‡ä»¶ä½¿ç”¨ `kebab-case.ts` æ ¼å¼
- [ ] Query Hook å‘½åéµå¾ª `use{Entity}{Action}` æ¨¡å¼
- [ ] Mutation Hook å‘½åéµå¾ª `use{Action}{Entity}` æ¨¡å¼
- [ ] Query Key ä½¿ç”¨ `["kebab-entity", "action"]` æ ¼å¼

#### æƒé™å±‚
- [ ] æƒé™å¸¸é‡ä½¿ç”¨ `UPPER_SNAKE_CASE` æ ¼å¼
- [ ] æƒé™å‰ç¼€ä¸æ¨¡å—åå¯¹åº” (ä½¿ç”¨ä¸‹åˆ’çº¿åˆ†éš”)

### 10.2 å¿«é€Ÿå‚è€ƒè¡¨

| å±‚çº§ | å‘½åè§„åˆ™ | ç¤ºä¾‹ | è¯´æ˜ |
|-----|---------|------|------|
| **æ•°æ®åº“è¡¨** | `snake_case` + å•æ•° | `site_category` | å­˜å‚¨è¾¹ç•Œ |
| **Schema å˜é‡** | `camelCase` + `Table` | `siteCategoryTable` | å†…å­˜è¾¹ç•Œ |
| **Contract æ–‡ä»¶** | `kebab-case` + `.contract.ts` | `site-category.contract.ts` | ç£ç›˜è¾¹ç•Œ |
| **Contract å¯¼å‡º** | `PascalCase` + `Contract` | `SiteCategoryContract` | ç±»å‹è¾¹ç•Œ |
| **Service æ–‡ä»¶** | `kebab-case` + `.service.ts` | `site-category.service.ts` | ç£ç›˜è¾¹ç•Œ |
| **Service ç±»** | `PascalCase` + `Service` | `SiteCategoryService` | ç±»å‹è¾¹ç•Œ |
| **Service å®ä¾‹** | `camelCase` + `Service` | `siteCategoryService` | å†…å­˜è¾¹ç•Œ |
| **Controller æ–‡ä»¶** | `kebab-case` + `.controller.ts` | `site-category.controller.ts` | ç£ç›˜è¾¹ç•Œ |
| **Controller å˜é‡** | `camelCase` + `Controller` | `siteCategoryController` | å†…å­˜è¾¹ç•Œ |
| **è·¯ç”± prefix** | `/kebab-case` | `/site-category` | ç½‘ç»œè¾¹ç•Œ |
| **è·¯ç”± tags** | `PascalCase` | `"SiteCategory"` | æ–‡æ¡£åˆ†ç»„ |
| **Hook æ–‡ä»¶** | `kebab-case.ts` | `site-category.ts` | ç£ç›˜è¾¹ç•Œ |
| **Hook Query** | `use{Entity}{Action}` | `useSiteCategoryList` | å†…å­˜è¾¹ç•Œ |
| **Hook Mutation** | `use{Action}{Entity}` | `useCreateSiteCategory` | å†…å­˜è¾¹ç•Œ |
| **æƒé™å¸¸é‡** | `UPPER_SNAKE_CASE` | `SITE_CATEGORY_VIEW` | é€»è¾‘è¾¹ç•Œ |

### 10.3 æ ¸å¿ƒåŸåˆ™å›é¡¾

1. **ç‰©ç†ç©ºé—´ (ç£ç›˜/ç½‘ç»œ)**: ä½¿ç”¨ `kebab-case`ï¼Œä¿è¯è§†è§‰æ¸…æ™°å’Œæ ‡å‡†å…¼å®¹
2. **é€»è¾‘ç©ºé—´ (å†…å­˜/ä»£ç )**: ä½¿ç”¨ `camelCase`/`PascalCase`ï¼Œç¬¦åˆè¯­è¨€ä¹ æƒ¯
3. **æŒä¹…ç©ºé—´ (æ•°æ®åº“)**: ä½¿ç”¨ `snake_case`ï¼Œéµå¾ªæ•°æ®åº“æƒ¯ä¾‹
4. **ç±»å‹è¾¹ç•Œ**: ä½¿ç”¨ `PascalCase`ï¼Œæ¸…æ™°åŒºåˆ†å®ä¾‹ä¸ç±»å‹
5. **è‡ªåŠ¨åŒ–æ˜ å°„**: é€šè¿‡è½¬æ¢å‡½æ•°å®ç°å„å±‚çº§çš„è‡ªåŠ¨æ¨å¯¼

### 10.4 æœ€ä½³å®è·µ


---

## é™„å½•: å¸¸ç”¨è½¬æ¢å·¥å…·å‡½æ•°

```typescript
/**
 * å‘½åè½¬æ¢å·¥å…·é›†
 * ç”¨äºä»£ç ç”Ÿæˆå™¨å’Œè‡ªåŠ¨åŒ–è„šæœ¬
 */
export const NamingUtils = {
  /**
   * kebab-case â†’ camelCase
   * site-category â†’ siteCategory
   */
  kebabToCamel(str: string): string {
    return str.replace(/-([a-z])/g, (_, c) => c.toUpperCase());
  },

  /**
   * kebab-case â†’ PascalCase
   * site-category â†’ SiteCategory
   */
  kebabToPascal(str: string): string {
    return str.charAt(0).toUpperCase() + this.kebabToCamel(str.slice(1));
  },

  /**
   * kebab-case â†’ snake_case
   * site-category â†’ site_category
   */
  kebabToSnake(str: string): string {
    return str.replace(/-/g, '_');
  },

  /**
   * kebab-case â†’ UPPER_SNAKE_CASE
   * site-category â†’ SITE_CATEGORY
   */
  kebabToUpperSnake(str: string): string {
    return this.kebabToSnake(str).toUpperCase();
  },

  /**
   * snake_case â†’ camelCase
   * site_category â†’ siteCategory
   */
  snakeToCamel(str: string): string {
    return str.replace(/_([a-z])/g, (_, c) => c.toUpperCase());
  },

  /**
   * snake_case â†’ kebab-case
   * site_category â†’ site-category
   */
  snakeToKebab(str: string): string {
    return str.replace(/_/g, '-');
  },

  /**
   * camelCase â†’ kebab-case
   * siteCategory â†’ site-category
   */
  camelToKebab(str: string): string {
    return str.replace(/([A-Z])/g, '-$1').toLowerCase();
  },

  /**
   * camelCase â†’ snake_case
   * siteCategory â†’ site_category
   */
  camelToSnake(str: string): string {
    return str.replace(/([A-Z])/g, '_$1').toLowerCase();
  },
};
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0 (æ¶æ„å¸ˆä¿®è®¢ç‰ˆ)
**æœ€åæ›´æ–°**: 2026-01-02
**ç»´æŠ¤è€…**: é¡¹ç›®æ¶æ„ç»„
