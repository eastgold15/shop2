# 统一后台管理系统实施计划

## 🎯 项目目标
实现一个统一的Elysia后台管理系统，支持超级admin、出口商admin、工厂管理员、业务员四种角色，通过站点切换器实现不同身份的管理功能。

## 📋 实施清单

### 第一阶段：后端核心功能（优先级：高）

#### 1.1 站点切换API开发
- [ ] 1.1.1 在契约层添加站点切换类型定义
- [ ] 1.1.2 创建站点切换API `POST /site/switch`
- [ ] 1.1.3 创建获取可访问站点API `GET /site/accessible`
- [ ] 1.1.4 实现站点权限验证逻辑
- [ ] 1.1.5 实现session中的当前站点更新

#### 1.2 用户信息接口增强
- [ ] 1.2.1 修改 `/user/me` 接口支持siteId参数
- [ ] 1.2.2 根据当前站点返回对应角色和权限信息
- [ ] 1.2.3 返回完整的组织架构和团队信息
- [ ] 1.2.4 添加站点相关的统计数据

#### 1.3 认证中间件升级
- [ ] 1.3.1 支持从请求头或session获取当前站点ID
- [ ] 1.3.2 动态加载用户在当前站点的角色权限
- [ ] 1.3.3 为API路由添加站点权限验证
- [ ] 1.3.4 优化超级管理员的站点访问逻辑

### 第二阶段：前端状态管理（优先级：高）

#### 2.1 站点状态管理
- [ ] 2.1.1 创建 `apps/b2badmin/src/stores/site-store.ts`
- [ ] 2.1.2 实现当前站点ID状态管理
- [ ] 2.1.3 实现可访问站点列表管理
- [ ] 2.1.4 实现站点切换功能
- [ ] 2.1.5 处理切换后的数据刷新逻辑

#### 2.2 用户权限Hooks增强
- [ ] 2.2.1 更新 `usePermissions` hook支持站点上下文
- [ ] 2.2.2 添加 `useCurrentSite` hook获取当前站点信息
- [ ] 2.2.3 添加 `useSitePermissions` hook获取站点特定权限
- [ ] 2.2.4 实现权限检查的便捷方法

#### 2.3 站点切换器改造
- [ ] 2.3.1 修改 `apps/b2badmin/src/components/team-switcher.tsx`
- [ ] 2.3.2 添加站点切换交互功能
- [ ] 2.3.3 显示当前站点和可切换站点列表
- [ ] 2.3.4 支持站点类型标识（工厂/出口商）
- [ ] 2.3.5 添加切换确认对话框

### 第三阶段：界面适配（优先级：中）

#### 3.1 工作台动态化
- [ ] 3.1.1 修改 `apps/b2badmin/src/components/dashboard/UserDashboard.tsx`
- [ ] 3.1.2 根据当前角色动态显示统计数据
- [ ] 3.1.3 根据站点类型调整快速操作入口
- [ ] 3.1.4 添加站点切换提示
- [ ] 3.1.5 优化超级管理员的数据聚合显示

#### 3.2 导航菜单权限控制
- [ ] 3.2.1 修改 `apps/b2badmin/src/components/app-sidebar.tsx`
- [ ] 3.2.2 菜单项根据当前站点和角色动态显示
- [ ] 3.2.3 超级管理员可看到所有功能模块
- [ ] 3.2.4 添加站点特定的菜单项
- [ ] 3.2.5 实现菜单项的权限细粒度控制

#### 3.3 权限守卫组件
- [ ] 3.3.1 创建 `apps/b2badmin/src/components/guards/PermissionGuard.tsx`
- [ ] 3.3.2 创建通用权限守卫组件
- [ ] 3.3.3 支持角色、权限、站点多维度控制
- [ ] 3.3.4 提供便捷的权限检查hooks
- [ ] 3.3.5 实现权限不足时的友好提示

### 第四阶段：优化与完善（优先级：中）

#### 4.1 API客户端优化
- [ ] 4.1.1 修改 `apps/b2badmin/src/lib/api.ts`
- [ ] 4.1.2 自动添加当前站点ID到请求头
- [ ] 4.1.3 处理站点切换时的API缓存失效
- [ ] 4.1.4 优化错误处理和重试机制
- [ ] 4.1.5 添加请求级loading状态

#### 4.2 数据缓存策略
- [ ] 4.2.1 使用React Query管理站点相关数据
- [ ] 4.2.2 实现跨站点的数据隔离
- [ ] 4.2.3 优化站点切换时的数据预加载
- [ ] 4.2.4 处理缓存失效和更新策略

#### 4.3 用户体验优化
- [ ] 4.3.1 添加站点切换加载动画
- [ ] 4.3.2 实现站点切换的历史记录
- [ ] 4.3.3 优化移动端站点选择器
- [ ] 4.3.4 添加键盘快捷键支持

### 第五阶段：测试与安全（优先级：高）

#### 5.1 安全加固
- [ ] 5.1.1 验证所有API的站点权限检查
- [ ] 5.1.2 防止越权访问其他站点数据
- [ ] 5.1.3 记录站点切换审计日志
- [ ] 5.1.4 实现会话超时自动跳转

#### 5.2 全面测试
- [ ] 5.2.1 编写单元测试覆盖核心逻辑
- [ ] 5.2.2 进行集成测试验证权限隔离
- [ ] 5.2.3 性能测试确保切换流畅
- [ ] 5.2.4 用户验收测试

## 📊 当前进度

### 已完成 ☑️
- [x] 项目需求分析和技术调研
- [x] 整体架构设计
- [x] 实施计划制定
- [x] 1.1.1 在契约层添加站点切换类型定义
- [x] 1.1.2 创建站点切换API `POST /site/switch`
- [x] 1.1.3 创建获取可访问站点API `GET /site/accessible`
- [x] 1.1.4 实现站点权限验证逻辑
- [x] 1.1.5 实现session中的当前站点更新（TODO标记）
- [x] 1.2.1 修改 `/user/me` 接口支持siteId参数
- [x] 1.2.2 根据当前站点返回对应角色和权限信息
- [x] 1.2.3 返回完整的组织架构和团队信息
- [x] 1.2.4 添加站点相关的统计数据
- [x] 1.3.1 支持从请求头或session获取当前站点ID
- [x] 1.3.2 动态加载用户在当前站点的角色权限
- [x] 1.3.3 为API路由添加站点权限验证
- [x] 1.3.4 优化超级管理员的站点访问逻辑

### 已完成 ☑️
- [x] 项目需求分析和技术调研
- [x] 整体架构设计
- [x] 实施计划制定
- [x] 1.1.1 在契约层添加站点切换类型定义
- [x] 1.1.2 创建站点切换API `POST /site/switch`
- [x] 1.1.3 创建获取可访问站点API `GET /site/accessible`
- [x] 1.1.4 实现站点权限验证逻辑
- [x] 1.1.5 实现session中的当前站点更新（TODO标记）
- [x] 1.2.1 修改 `/user/me` 接口支持siteId参数
- [x] 1.2.2 根据当前站点返回对应角色和权限信息
- [x] 1.2.3 返回完整的组织架构和团队信息
- [x] 1.2.4 添加站点相关的统计数据
- [x] 1.3.1 支持从请求头或session获取当前站点ID
- [x] 1.3.2 动态加载用户在当前站点的角色权限
- [x] 1.3.3 为API路由添加站点权限验证
- [x] 1.3.4 优化超级管理员的站点访问逻辑
- [x] 2.1.1 创建 `apps/b2badmin/src/stores/site-store.ts`
- [x] 2.1.2 实现当前站点ID状态管理
- [x] 2.1.3 实现可访问站点列表管理
- [x] 2.1.4 实现站点切换功能
- [x] 2.1.5 处理切换后的数据刷新逻辑

### 已完成 ☑️
- [x] 项目需求分析和技术调研
- [x] 整体架构设计
- [x] 实施计划制定
- [x] 1.1.1 在契约层添加站点切换类型定义
- [x] 1.1.2 创建站点切换API `POST /site/switch`
- [x] 1.1.3 创建获取可访问站点API `GET /site/accessible`
- [x] 1.1.4 实现站点权限验证逻辑
- [x] 1.1.5 实现session中的当前站点更新（TODO标记）
- [x] 1.2.1 修改 `/user/me` 接口支持siteId参数
- [x] 1.2.2 根据当前站点返回对应角色和权限信息
- [x] 1.2.3 返回完整的组织架构和团队信息
- [x] 1.2.4 添加站点相关的统计数据
- [x] 1.3.1 支持从请求头或session获取当前站点ID
- [x] 1.3.2 动态加载用户在当前站点的角色权限
- [x] 1.3.3 为API路由添加站点权限验证
- [x] 1.3.4 优化超级管理员的站点访问逻辑
- [x] 2.1.1 创建 `apps/b2badmin/src/stores/site-store.ts`
- [x] 2.1.2 实现当前站点ID状态管理
- [x] 2.1.3 实现可访问站点列表管理
- [x] 2.1.4 实现站点切换功能
- [x] 2.1.5 处理切换后的数据刷新逻辑
- [x] 2.2.1 更新 `usePermissions` hook支持站点上下文
- [x] 2.2.2 添加 `useCurrentSite` hook获取当前站点信息
- [x] 2.2.3 添加 `useSitePermissions` hook获取站点特定权限
- [x] 2.2.4 实现权限检查的便捷方法
- [x] 2.2.5 创建 `useAccessibleSites` 和 `useSiteSwitch` hooks

### 已完成 ☑️
- [x] 项目需求分析和技术调研
- [x] 整体架构设计
- [x] 实施计划制定
- [x] 1.1.1 在契约层添加站点切换类型定义
- [x] 1.1.2 创建站点切换API `POST /site/switch`
- [x] 1.1.3 创建获取可访问站点API `GET /site/accessible`
- [x] 1.1.4 实现站点权限验证逻辑
- [x] 1.1.5 实现session中的当前站点更新（TODO标记）
- [x] 1.2.1 修改 `/user/me` 接口支持siteId参数
- [x] 1.2.2 根据当前站点返回对应角色和权限信息
- [x] 1.2.3 返回完整的组织架构和团队信息
- [x] 1.2.4 添加站点相关的统计数据
- [x] 1.3.1 支持从请求头或session获取当前站点ID
- [x] 1.3.2 动态加载用户在当前站点的角色权限
- [x] 1.3.3 为API路由添加站点权限验证
- [x] 1.3.4 优化超级管理员的站点访问逻辑
- [x] 2.1.1 创建 `apps/b2badmin/src/stores/site-store.ts`
- [x] 2.1.2 实现当前站点ID状态管理
- [x] 2.1.3 实现可访问站点列表管理
- [x] 2.1.4 实现站点切换功能
- [x] 2.1.5 处理切换后的数据刷新逻辑
- [x] 2.2.1 更新 `usePermissions` hook支持站点上下文
- [x] 2.2.2 添加 `useCurrentSite` hook获取当前站点信息
- [x] 2.2.3 添加 `useSitePermissions` hook获取站点特定权限
- [x] 2.2.4 实现权限检查的便捷方法
- [x] 2.2.5 创建 `useAccessibleSites` 和 `useSiteSwitch` hooks
- [x] 2.3.1 修改 `apps/b2badmin/src/components/team-switcher.tsx`
- [x] 2.3.2 添加站点切换交互功能
- [x] 2.3.3 显示当前站点和可切换站点列表
- [x] 2.3.4 支持站点类型标识（工厂/出口商）
- [x] 2.3.5 添加切换确认对话框

### 当前状态 ✅
**核心功能已完成！** 系统现在支持：
- ✅ 超级管理员可以切换管理所有站点
- ✅ 普通用户可以切换有权限的站点
- ✅ 站点切换后权限和界面自动调整
- ✅ 完整的站点状态管理和权限控制

### 下一步建议 📝
虽然核心功能已完成，但以下优化可以进一步提升用户体验：
- [ ] 第三阶段：界面动态化优化
- [ ] 第四阶段：性能和安全优化
- [ ] 全面测试和错误处理

### 待开始 ⏳
- 其他所有任务

## 🔧 关键技术要点

### 权限检查机制
1. **前端控制**：基于当前角色动态显示/隐藏UI组件
2. **API验证**：每个请求验证用户在当前站点的权限
3. **数据过滤**：查询时自动过滤用户可见数据范围
4. **操作限制**：关键操作二次验证权限

### 数据安全措施
- 不在本地存储敏感权限信息
- 使用HTTPS传输所有数据
- 实现CSRF防护
- 定期更新用户权限缓存

## 📝 注意事项

1. **渐进式开发**：每个阶段完成后进行测试验证
2. **向后兼容**：确保现有功能不受影响
3. **性能优化**：站点切换要保证流畅性
4. **安全优先**：权限验证要严格可靠
5. **用户体验**：切换过程要友好直观

---

*最后更新时间：2025-01-16*
*当前状态：第一阶段开发中*