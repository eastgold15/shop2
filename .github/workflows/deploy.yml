name: ğŸš€ æœ¬åœ°è§¦å‘éƒ¨ç½²åˆ°æœåŠ¡å™¨

on:
  workflow_dispatch: # æ”¯æŒåœ¨ VS Code æ’ä»¶ç•Œé¢æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # act ä¼šæ˜ å°„åˆ°æœ¬åœ° Docker é•œåƒ
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4



      - name: ğŸ” éªŒè¯æœ¬åœ°æ–‡ä»¶ (åŒ…æ‹¬ .env)
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          ls -F
          echo "æŸ¥çœ‹æ˜¯å¦å­˜åœ¨ç¯å¢ƒå˜é‡æ–‡ä»¶:"
          find apps -name ".env*"
          # å¦‚æœæ–‡ä»¶åœ¨ï¼Œå°±ç›´æ¥å¼€å§‹æ„å»º
          find apps -name ".next" -exec echo "æ‰¾åˆ° .next ç›®å½•: {}" \;

      # ç¬¬ä¸€æ­¥ï¼šåœ¨æœ¬åœ° Action ç¯å¢ƒä¸­æ„å»ºï¼ˆä¿æŒä»“åº“å¹²å‡€ï¼Œä¸ç”¨æäº¤ distï¼‰
      - name: ğŸ“¦ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: ğŸ“¥ å®‰è£…ä¾èµ–å¹¶æ„å»º
        run: |
          npm install -g rimraf  
          bun install
      

      - name: Copy files via SSH
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          source: " apps/b2badmin/.next/*"
          target: "/5/shop2/apps/b2badmin/.next"

      # # ç¬¬äºŒæ­¥ï¼šå°†æœ¬åœ°æ„å»ºå¥½çš„äº§ç‰©åˆ†å‘åˆ°æœåŠ¡å™¨
      # - name: ğŸšš åŒæ­¥äº§ç‰©åˆ°æœåŠ¡å™¨ (SFTP)
      #   uses: wlixcc/SFTP-Deploy-Action@v1.2.4
      #   with:
      #     username: "root"
      #     server: "139.196.30.42"
      #     # å¦‚æœä½ åœ¨æ’ä»¶ Settings -> Secrets é‡Œé…ç½®äº†å¯†ç ï¼Œç”¨ }}
      #     # å¦‚æœæ²¡é…ï¼Œå¯ä»¥ç›´æ¥å…ˆå†™æ­»åœ¨è¿™é‡Œï¼ˆä»…é™æœ¬åœ°ä¸ªäººä½¿ç”¨ï¼‰
      #     password: "Xlw123##"
      #     local_path: apps/b2badmin/.next/*
      #     remote_path: "/5/shop2/apps/b2badmin/.next"
      #     sftp_only: true

      # - name: ğŸšš åŒæ­¥äº§ç‰©åˆ°æœåŠ¡å™¨ (SFTP)
      #   uses: wlixcc/SFTP-Deploy-Action@v1.2.4
      #   with:
      #     username: "root"
      #     server: "139.196.30.42"
      #     password: "Xlw123##"
      #     local_path:  apps/web/.next/*
      #     remote_path: "/5/shop2/apps/web/.next"
      #     sftp_only: true

      # - name: ğŸšš åŒæ­¥äº§ç‰©åˆ°æœåŠ¡å™¨ (SFTP)
      #   uses: wlixcc/SFTP-Deploy-Action@v1.2.4
      #   with:
      #     username: "root"
      #     server: "139.196.30.42"
      #     password: "Xlw123##"
      #     local_path: apps/api/dist/*
      #     remote_path: "/5/shop2/apps/api/dist"
      #     sftp_only: true

      # ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡ SSH è¿œç¨‹é‡å¯ PM2
      # - name: ğŸ”„ PM2 é‡å¯æœåŠ¡
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: "139.196.30.42"
      #     username: "root"
      #     password: ${{ secrets.SERVER_PASS }}
      #     script: |
      #       echo "å¼€å§‹é‡å¯æœåŠ¡..."
      #       # è‡ªåŠ¨æ ¹æ®ä½ çš„ç›®å½•é‡è½½æ‰€æœ‰ PM2 è¿›ç¨‹
      #       pm2 reload all || pm2 restart all
      #       pm2 status